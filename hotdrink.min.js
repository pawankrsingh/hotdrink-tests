var hd;!function(t){var e;!function(t){var e;!function(t){function e(t,e){return{x:t.x-e.x,y:t.y-e.y}}t.difference=e}(e=t.point||(t.point={}));var n;!function(t){function e(t){return t.slice(0)}function n(t,e){return-1!=t.indexOf(e)}function r(t,e){return-1==t.indexOf(e)&&t.push(e),t}function i(t,e){return-1==t.indexOf(e)?(t.push(e),!0):!1}function o(t,e){t.push(e)}function s(t,e){var n=t.indexOf(e);return-1!=n?(t.splice(n,1),!0):!1}function a(t,e){return t.concat(e.filter(function(e){return-1==t.indexOf(e)}))}function h(t,e){return t.concat(e)}function u(t,e){return t.filter(function(t){return-1!=e.indexOf(t)})}function c(t,e){return t.filter(function(t){return-1==e.indexOf(t)})}function d(t,e){return t.every(function(t){return-1!=e.indexOf(t)})}function p(t,e){return t.every(function(t){return-1==e.indexOf(t)})}function l(t,e){return t.length==e.length&&d(t,e)}function f(t){var e=r,n=t.reduce(e,[]);return n}t.clone=e,t.contains=n,t.build=r,t.add=i,t.addKnownDistinct=o,t.remove=s,t.union=a,t.unionKnownDisjoint=h,t.intersect=u,t.difference=c,t.isSubset=d,t.areDisjoint=p,t.areEqual=l,t.fromArray=f}(n=t.arraySet||(t.arraySet={}));var r;!function(t){function e(t){var e={};for(var n in t)t[n]&&(e[n]=!0);return e}function n(t,e){return t[e]}function r(t,e){return t[e]=!0,t}function i(t,e){return t[e]?!1:t[e]=!0}function o(t,e){return t[e]?(delete t[e],!0):!1}function s(t,e,n){void 0===n&&(n=null);for(var r in t)e.call(n,r)}function a(t,e){var n={};for(var r in t)n[r]=!0;for(var r in e)n[r]=!0;return n}function h(t,e){var n={};for(var r in t)e[r]&&(n[r]=!0);return n}function u(t,e){var n={};for(var r in t)r in e||(n[r]=!0);return n}function c(t){return t.reduce(r,{})}t.clone=e,t.contains=n,t.build=r,t.add=i,t.remove=o,t.members=Object.keys,t.forEach=s,t.union=a,t.intersect=h,t.difference=u,t.fromArray=c}(r=t.stringSet||(t.stringSet={}));var i=function(){function t(){this.begin=0,this.end=0}return t.prototype.isEmpty=function(){return this.begin==this.end},t.prototype.isNotEmpty=function(){return this.begin!=this.end},t.prototype.enqueue=function(t){this[this.end++]=t},t.prototype.dequeue=function(){var t=this[this.begin];return this[this.begin]=void 0,++this.begin,this.begin>=this.end&&(this.begin=this.end=0),t},t.prototype.remove=function(t){for(var e=!1,n=this.begin,r=this.end;r>n;++n)e||this[n]!==t||(e=!0),e&&(this[n]=this[n+1]);e&&(--this.end,this.begin>=this.end&&(this.begin=this.end=0))},t}();t.Queue=i;var o=function(){function t(t){this.members=[],this.length=0,this.comesBefore=t}return t.prototype.contains=function(t){return this.members.indexOf(t)>=0},t.prototype.push=function(t){this.members.push(t),this.upheap(this.length),++this.length},t.prototype.pushAll=function(t){for(var e=0,n=t.length;n>e;++e)this.members.push(t[e]),this.upheap(this.length),++this.length},t.prototype.pop=function(){var t=this.members[0],e=this.members.pop();return--this.length>0&&(this.members[0]=e,this.downheap(0)),t},t.prototype.upheap=function(t){for(var e=this.members[t];t>0;){var n=Math.floor((t+1)/2)-1,r=this.members[n];if(!this.comesBefore(e,r))break;this.members[n]=e,this.members[t]=r,t=n}},t.prototype.downheap=function(t){for(var e=this.members.length,n=this.members[t];;){var r=2*t+1;if(!(e>r))break;var i=this.members[r],o=r+1;if(e>o){var s=this.members[o];this.comesBefore(s,i)&&(r=o,i=s)}if(!this.comesBefore(i,n))break;this.members[r]=n,this.members[t]=i,t=r}},t}();t.Heap=o}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r=Array.prototype.slice.call(arguments,1);return function(){var e=Array.prototype.slice.call(arguments,0);return t.bind.apply(t,[null].concat(r,e))}}function n(){}function r(t){var e=t,n=Object.create(Object.getPrototypeOf(t));for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);return n}function i(t){var e=t,n=Array.isArray(t)?[]:Object.create(Object.getPrototypeOf(t));for(var r in e)e.hasOwnProperty(r)&&(n[r]="object"==typeof e[r]?i(e[r]):e[r]);return n}function o(t,e){return t.reduce(function(t,n){var r=e(n);return r in t?t[r].push(n):t[r]=[n],t},{})}function s(t,e,n){void 0===n&&(n=null);for(var r=[],i=0,o=t.length;o>i;++i){var s=e.call(n,t[i],i,t);Array.prototype.push.apply(r,Array.isArray(s)?s:[s])}return r}function a(t,e,n){void 0===n&&(n=null);for(var r=[],i=t.length-1;i>=0;--i)r.push(e.call(n,t[i],i,t));return r}function h(){for(var t=[],e=0,n=arguments.length;n>e;++e){var r=arguments[e];Array.isArray(r)?t.push.apply(t,r):void 0!==r&&t.push(r)}return t}function u(t,e){return t-e}function c(t,e){return t.valueOf()-e.valueOf()}function d(t){return function(e){return e instanceof t}}function p(t){return function(e){return!(e instanceof t)}}function l(t){return function(e){return e in t}}function f(t){return function(e){return!(e in t)}}function v(t){return function(e){return t[e]}}function g(t){return t.id}function m(t,e){return t==e}function y(t){return null!==t}function b(t){return void 0===t}t.makeConstructorBinder=e,function(t){t[t.No=0]="No",t[t.Yes=1]="Yes",t[t.Maybe=2]="Maybe"}(t.Fuzzy||(t.Fuzzy={}));t.Fuzzy;t.noop=n,t.shallowCopy=r,t.deepCopy=i,t.partition=o,t.concatmap=s,t.reversemap=a,t.interpolate=h,t.numCompare=u,t.dateCompare=c,t.isType=d,t.isNotType=p,t.nameIsIn=l,t.nameIsNotIn=f,t.toValueIn=v,t.getId=g,t.doubleEqual=m,t.isNotNull=y,t.isUndefined=b}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(){}(hd||(hd={})),hd.globalConsole=console;var hd;!function(t){var e;!function(e){function n(e){var n=t.globalConsole;return n[e]?n[e].bind(t.globalConsole):void 0}function r(t){e.console[t]=a[t]=s}function i(t){e.console[t]=a[t]=a}var o=function(){function t(){this.dir=e.noop,this.error=e.noop,this.group=e.noop,this.groupCollapsed=e.noop,this.groupEnd=e.noop,this.info=e.noop,this.log=e.noop,this.time=e.noop,this.timeEnd=e.noop,this.trace=e.noop,this.warning=e.noop,this.async=this,this.compile=this}return t}();e.Console=o,e.console=new o;var s=new o,a=new o;e.console.dir=s.dir=n("dir"),e.console.error=s.error=n("error"),e.console.group=s.group=n("group"),e.console.groupCollapsed=s.groupCollapsed=n("groupCollapsed"),e.console.groupEnd=s.groupEnd=n("groupEnd"),e.console.info=s.info=n("info"),e.console.log=s.log=n("log"),e.console.time=s.time=n("time"),e.console.timeEnd=s.timeEnd=n("timeEnd"),e.console.trace=s.trace=n("trace"),e.console.warning=s.warning=n("warning"),r("async"),i("compile"),e.enableConsole=r,e.disableConsole=i}(e=t.utility||(t.utility={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(){do{for(var t=null,n=0;null===t&&n<o.length;++n){var r=o[n];r&&r.isNotEmpty()&&(t=r.dequeue())}t?(t.run(),--s):s=0}while(s>0);a=s?setTimeout(e,0):null}function n(n,r,h){for(var u=[],c=3;c<arguments.length;c++)u[c-3]=arguments[c];if(0>n){try{r.apply(h,u)}catch(d){t.console.error(d)}return null}var p=new i(n,r,h,u),l=o[n];return void 0===l&&(l=o[n]=new t.Queue),l.enqueue(p),++s,a||(a=setTimeout(e,0)),p}function r(t){var e=o[t.priority];e&&e.remove(t)}var i=function(){function e(t,e,n,r){this.priority=t,this.fn=e,this.thisArg=n,this.params=r}return e.prototype.run=function(){try{this.fn.apply(this.thisArg,this.params)}catch(e){t.console.error(e)}},e}();t.ScheduledTask=i;var o=[],s=0,a=null;t.schedule=n,t.deschedule=r}(e=t.utility||(t.utility={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(t){t.ObservablePriority=-1;var e=function(){function t(t,e,n,r,i){this.object=t,this.next_cb=e,this.error_cb=n,this.completed_cb=r,this.id=i}return t.prototype.onNext=function(t){this.next_cb&&this.next_cb.call(this.object,t,this.id)},t.prototype.onError=function(t){this.error_cb&&this.error_cb.call(this.object,t,this.id)},t.prototype.onCompleted=function(){this.completed_cb&&this.completed_cb.call(this.object,this.id)},t}();t.ProxyObserver=e;var n=function(){function t(){}return t.prototype.hasObservers=function(){return this["#observers"].length>0},t.prototype.addObserver=function(t,n,r,i,o){var s;return s=1==arguments.length?t:new e(t,n,r,i,o),this.hasOwnProperty("#observers")?this["#observers"].push(s):this["#observers"]=[s],s},t.prototype.removeObserver=function(t){for(var n=!1,r=this["#observers"].length;r>=0;--r){var i=this["#observers"][r];(i===t||i instanceof e&&i.object===t)&&(this["#observers"].splice(r,1),n=!0)}return n},t.prototype.sendNext=function(t){this["#observers"].slice(0).forEach(function(e){e.onNext(t)})},t.prototype.sendError=function(t){this["#observers"].slice(0).forEach(function(e){e.onError(t)})},t.prototype.sendCompleted=function(){this["#observers"].slice(0).forEach(function(t){t.onCompleted()}),delete this["#observers"]},t}();t.BasicObservable=n,n.prototype["#observers"]=[];var r=function(t){function e(e){t.call(this),this.completedCount=0,this.count=e.length,e.forEach(function(t){t.addObserver(this)})}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t)},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){++this.completedCount==this.count&&this.sendCompleted()},e}(n);t.Union=r}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility;e.SignalPriority=3;var r;!function(t){t[t.None=0]="None",t[t.Init=1]="Init",t[t.Update=2]="Update"}(r||(r={}));var i=function(t){function e(e,n){t.call(this),this.value=e,n&&(this.eq=n)}return __extends(e,t),e.prototype.addObserver=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&void 0!==this.value&&s.onNext(this.value),s},e.prototype.addObserverChangesOnly=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o)},e.prototype.set=function(t){this.hasValue(t)||(this.value=t,this.sendNext(t))},e.prototype.get=function(){return this.value},e.prototype.hasValue=function(t){return this.eq?this.eq(this.value,t):void 0===this.value&&void 0===t},e}(e.BasicObservable);e.BasicSignal=i;var o=function(t){function r(e,n){t.call(this),this.scheduled=0,this.needInit=null,this.value=e,n&&(this.eq=n)}return __extends(r,t),r.prototype.scheduleUpdate=function(){0===this.scheduled?(this.scheduled=2,n.schedule(e.SignalPriority,this.update,this)):this.scheduled=2},r.prototype.scheduleInit=function(t){this.needInit?this.needInit.push(t):this.needInit=[t],0===this.scheduled&&(this.scheduled=1,n.schedule(e.SignalPriority,this.update,this))},r.prototype.update=function(){var t=this.scheduled;this.scheduled=0;var r=this.needInit;this.needInit=null,2===t&&(this.hasValue(this.lastUpdate)?t=1:(this.lastUpdate=this.value,this.sendNext(this.value))),1===t&&r&&r.forEach(function(t){n.schedule(e.ObservablePriority,t.onNext,t,this.value)},this)},r.prototype.addObserver=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&void 0!==this.value&&this.scheduleInit(s),s},r.prototype.addObserverChangesOnly=function(e,n,r,i,o){var s;return s=1===arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o)},r.prototype.set=function(t){this.hasValue(t)||(this.value=t,this.scheduleUpdate())},r.prototype.get=function(){return this.value},r.prototype.hasValue=function(t){return this.eq?this.eq(this.value,t):!1},r}(e.BasicObservable);e.ScheduledSignal=o}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t)},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){this.sendCompleted()},e}(t.BasicObservable);t.Extension=e;var n=function(t){function e(e,n,r){t.call(this),this.fn=r&&r.length?e.bind.apply(e,[n||null].concat(r)):e}return __extends(e,t),e.prototype.onNext=function(t){try{this.sendNext(this.fn(t))}catch(e){this.sendError(e)}},e.prototype.onError=function(t){this.sendError(t)},e.prototype.onCompleted=function(){this.sendCompleted()},e}(e);t.FunctionExtension=n;var r=function(){function t(t){this.value=t}return t.prototype.addObserver=function(t){t.onNext(this.value)},t.prototype.removeObserver=function(){},t.prototype.onNext=function(){},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();t.Constant=r;var i=function(t){function e(e){t.call(this),this.exts=e=e?e.slice(0):[];for(var n=1,r=e.length;r>n;++n)e[n-1].addObserver(e[n]);n>1&&this.forward(e[r-1])}return __extends(e,t),e.prototype.forward=function(t){t.addObserver(this,this.sendNext,this.sendError,this.sendCompleted)},e.prototype.onNext=function(t){this.exts.length?this.exts[0].onNext(t):this.sendNext(t)},e.prototype.onError=function(t){this.exts.length?this.exts[0].onError(t):this.sendError(t)},e.prototype.onCompleted=function(){this.exts.length?this.exts[0].onCompleted():this.sendCompleted()},e.prototype.push=function(t){if(this.exts.length){var e=this.exts[this.exts.length-1];e.removeObserver(this),e.addObserver(t)}this.forward(t),this.exts.push(t)},e.prototype.pop=function(){if(this.exts.length){var t=this.exts.pop();t.removeObserver(this),this.exts.length&&this.forward(this.exts[this.exts.length-1])}return t},e.prototype.unshift=function(t){this.exts.length?t.addObserver(this.exts[0]):this.forward(t),this.exts.unshift(t)},e.prototype.shift=function(){if(this.exts.length){var t=this.exts.shift();t.removeObserver(this.exts.length?this.exts[0]:this)}return t},e}(t.BasicObservable);t.Chain=i;var o=function(e){function n(n){e.call(this),this.proxy=new t.ProxyObserver(this,this.onSourceNext,this.onSourceError,this.onSourceCompleted),this.source=n,n&&n.addObserver(this.proxy)}return __extends(n,e),n.prototype.onSourceNext=function(t){this.sendNext(t)},n.prototype.onSourceError=function(t){this.sendError(t)},n.prototype.onSourceCompleted=function(){this.sendCompleted()},n.prototype.onNext=function(t){this.source&&this.source.removeObserver(this.proxy),this.source=t,t&&t.addObserver(this.proxy)},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(t.BasicObservable);t.HotSwapObservable=o;var s=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.get=function(){return this.source?this.source.get():void 0},e.prototype.onNext=function(t){var e=this.source;this.source=t,e&&e.removeObserver(this.proxy),t&&t.addObserver(this.proxy),e&&!t&&this.sendNext(void 0)},e}(o);t.HotSwapSignal=s;var a=function(t){function e(e){t.call(this),this.source=e,this.target=null,e.addObserver(this,this.onNextTarget,null,null),e&&this.onNextTarget(e.get())}return __extends(e,t),e.prototype.addObserver=function(){var e=t.prototype.addObserver.apply(this,arguments);return void 0!==this.last&&e.onNext(this.last),e},e.prototype.onNextTarget=function(t){this.target&&this.target.removeObserver(this),this.target=t,this.target&&t.addObserver(this,this.onTargetNext,this.onTargetError,this.onTargetCompleted)},e.prototype.onNext=function(t){this.target&&this.target.onNext(t)},e.prototype.onError=function(t){this.target&&this.target.onError(t)},e.prototype.onCompleted=function(){this.target&&this.target.onCompleted()},e.prototype.onTargetNext=function(t){this.last=t,this.sendNext(t)},e.prototype.onTargetError=function(t){this.sendError(t)},e.prototype.onTargetCompleted=function(){this.sendCompleted(),this.target=null},e}(t.BasicObservable);t.HotSwap=a;var h=function(t){function e(e,n){t.call(this),this.read=e,this.write=n}return __extends(e,t),e.prototype.addObserver=function(){return this.read.addObserver.apply(this.read,arguments)},e.prototype.removeObserver=function(t){return this.read.removeObserver(t),!0},e.prototype.onNext=function(t){this.write.onNext(t)},e.prototype.onError=function(t){this.write.onNext(t)},e.prototype.onCompleted=function(){this.write.onCompleted()},e}(e);t.ReadWrite=h;var u=function(t){function e(e){t.call(this),this.time_ms=e}return __extends(e,t),e.prototype.onNext=function(t){setTimeout(this.sendNext.bind(this,t),this.time_ms)},e.prototype.onError=function(t){setTimeout(this.sendError.bind(this,t),this.time_ms)},e.prototype.onCompleted=function(){setTimeout(this.sendCompleted.bind(this),this.time_ms)},e}(e);t.Delay=u;var c;!function(t){t[t.None=0]="None",t[t.Next=1]="Next",t[t.Error=2]="Error"}(c||(c={}));var d=function(t){function e(e,n){void 0===e&&(e=400),t.call(this),this.state=0,this.task=null,this.time=e,this.flush=n,this.onTimeout=this.onTimeout.bind(this)}return __extends(e,t),e.prototype.onNext=function(t){void 0!==this.flush&&t===this.flush?this.task&&(clearTimeout(this.task),this.onTimeout()):(this.state=1,this.arg=t,this.task&&clearTimeout(this.task),this.task=setTimeout(this.onTimeout,this.time))},e.prototype.onError=function(t){this.state=2,this.arg=t,this.task&&clearTimeout(this.task),this.task=setTimeout(this.onTimeout,this.time)},e.prototype.onCompleted=function(){this.task&&(clearTimeout(this.task),this.onTimeout()),this.sendCompleted()},e.prototype.onTimeout=function(){1==this.state?this.sendNext(this.arg):2==this.state&&this.sendError(this.arg),this.state=0,this.task=null},e}(e);t.Stabilizer=d;var p=function(t){function e(e){t.call(this),this.replacement=e}return __extends(e,t),e.prototype.onError=function(){this.sendError(this.replacement)},e}(e);t.ReplaceError=p;var l=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){void 0===t||null===t||""===t?this.sendError("Required"):this.sendNext(t)},e}(e);t.Required=l;var f=function(t){function e(e){t.call(this),this.defaultValue=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(void 0===t||null===t||""===t?this.defaultValue:t)},e.prototype.onError=function(){this.sendNext(this.defaultValue)},e}(e);t.Default=f;var v=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(void 0===t||null===t?"":t.toString())},e}(e);t.ToString=v;var g=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(JSON.stringify(t))},e}(e);t.ToJson=g;var m=function(t){function e(e){if(void 0===e&&(e=0),t.call(this),this.scale=1,0>e)for(var n=0,r=e;n>r;--n)this.scale/=10;else for(var n=0,r=e;r>n;++n)this.scale*=10}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(Math.round(t*this.scale)/this.scale)},e}(e);t.Round=m;var y=function(t){function e(e){t.call(this),this.places=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toFixed(this.places))},e}(e);t.NumberToFixed=y;var b=function(t){function e(e){t.call(this),this.sigfigs=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toPrecision(this.sigfigs))},e}(e);t.NumberToPrecision=b;var x=function(t){function e(e){t.call(this),this.places=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t.toExponential(this.places))},e}(e);t.NumberToExponential=x;var w=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){var e=Number(t);""==t||isNaN(e)||1/0===e?this.sendError("Invalid number"):this.sendNext(e)},e}(e);t.ToNumber=w;var C=function(t){function e(e){t.call(this),this.scale=1,this.scale=e}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(this.scale*t)},e}(e);t.ScaleNumber=C;var O=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){var e;""==t||isNaN((e=new Date(t)).getTime())?this.sendError("Invalid date"):this.sendNext(e)},e}(e);t.ToDate=O;var N=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleString():"")},e}(e);t.DateToString=N;var E=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleDateString():"")},e}(e);t.DateToDateString=E;var S=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.toLocaleTimeString():"")},e}(e);t.DateToTimeString=S;var T=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(t?t.getTime():0)},e}(e);t.DateToMilliseconds=T;var k=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext(new Date(t))},e}(e);t.MillisecondsToDate=k;var P=function(t){function e(e,n){t.call(this),this.dx=e,this.dy=n}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext({x:t.x+this.dx,y:t.y+this.dy})},e}(e);t.Offset=P;var M=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.onNext=function(t){this.sendNext("("+t.x+", "+t.y+")")},e}(e);t.PointToString=M;var F=function(e){function n(n){e.call(this),this.values=[],this.completed=0;for(var r=0,i=n.length;i>r;++r)n[r].addObserver(new t.ProxyObserver(this,this.onNext,this.onError,this.onCompleted,r))}return __extends(n,e),n.prototype.onNext=function(t,e){this.values[e]=t,this.update()},n.prototype.onError=function(t,e){this.values[e]=void 0,this.update()},n.prototype.onCompleted=function(){++this.completed,this.completed==this.values.length&&this.sendCompleted()},n.prototype.update=function(){for(var t=this.values[0],e=1,n=this.values.length;!t&&n>e;++e)this.values[e]&&(t=this.values[e]);t!==this.mine&&(this.mine=t,this.sendNext(t))},n}(t.BasicObservable);t.Or=F}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){t.then(function(t){n(e,t)})}function r(t,e,n,r,i){try{var o=t.call(e,n,r);i&&i.resolve(o)}catch(s){console.warn(s),i&&i.reject(s)}}var i=t.utility;e.PromisePriority=2,e.DroppedPriority=1;var o=function(){function t(t,e,n,r,i,o){this.object=t,this.fulfilled_cb=e,this.rejected_cb=n,this.progress_cb=r,this.id=i,this.promise=o}return t.prototype.onFulfilled=function(t){this.fulfilled_cb?r(this.fulfilled_cb,this.object,t,this.id,this.promise):this.promise&&this.promise.resolve(t)},t.prototype.onRejected=function(t){this.rejected_cb?r(this.rejected_cb,this.object,t,this.id,this.promise):this.promise&&this.promise.reject(t)},t.prototype.onProgress=function(t){this.progress_cb&&r(this.progress_cb,this.object,t,this.id,void 0)},t}();!function(t){t[t.Pending=0]="Pending",t[t.Fulfilled=1]="Fulfilled",t[t.Rejected=2]="Rejected"}(e.State||(e.State={}));e.State;!function(t){t[t.Unknown=0]="Unknown",t[t.Used=1]="Used",t[t.Unused=2]="Unused",t[t.Delayed=3]="Delayed"}(e.Usage||(e.Usage={}));var s=(e.Usage,function(t){function r(n){t.call(this),this.state=0,this.open=!0,this.usage=new e.BasicSignal(0),this.ondropped=new e.BasicObservable,arguments.length>0&&this.resolve(n)}return __extends(r,t),r.prototype.isFulfilled=function(){return 1===this.state},r.prototype.isRejected=function(){return 2===this.state},r.prototype.isPending=function(){return 0===this.state},r.prototype.isSettled=function(){return 0!==this.state},r.prototype.hasValue=function(){return"value"in this},r.prototype.inspect=function(){return 1===this.state?{state:"fulfilled",value:this.value}:2===this.state?{state:"rejected",reason:this.reason}:"value"in this?{state:"pending",value:this.value}:{state:"pending"}},r.prototype.addDependency=function(t,n,r,s,a){var h;return h=1==arguments.length?t:new o(t,n,r,s,a),0!==this.state?i.schedule(e.PromisePriority,this.dischargeDependency,this,h):(e.plogger&&0==this.dependencies.length&&e.plogger.nowHasDependencies(this),this.hasOwnProperty("dependencies")?this.dependencies.push(h):this.dependencies=[h]),0===this.usage.get()&&this.usage.set(1),h},r.prototype.bindDependency=function(t,e,n,r,i,o){var s;if(arguments.length<3){var a=e;s=this.addDependency(e,a.onFulfilled,a.onRejected,a.onProgress)}else s=this.addDependency(e,n,r,i,o);return s.promise=t,s},r.prototype.removeDependency=function(t){for(var n=!1,r=this.dependencies.length-1;r>=0;--r){var s=this.dependencies[r];(s===t||s instanceof o&&s.object===t)&&(this.dependencies.splice(r,1),0==this.dependencies.length&&(e.plogger&&e.plogger.lostAllDependencies(this),i.schedule(e.DroppedPriority,this.ondropped.sendNext,this.ondropped,this)),n=!0)}return n},r.prototype.hasDependencies=function(){return this.dependencies.length>0},r.prototype.resolve=function(t){this.open&&this.resolveFirst(t)},r.prototype.resolveFirst=function(t){0===this.state&&(t===this?this.reject(new TypeError("Attempted to resolve a promise with itself")):t instanceof r?(this.open=!1,t.addDependency(this)):"object"!=typeof t&&"function"!=typeof t||"function"!=typeof t.then?this.fulfill(t):(this.open=!1,this.resolveThen(t)))},r.prototype.resolveThen=function(t){var e=!0,n=this;try{t.then(function(t){e&&(e=!1,n.resolve(t))},function(t){e&&(e=!1,n.reject(t))},function(t){e&&n.notify(t)})}catch(r){e&&(e=!1,n.reject(r))}},r.prototype.fulfill=function(t){this.state=1,this.value=t,e.plogger&&e.plogger.isSettled(this);var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onFulfilled(t)},this),this.sendNext(t),delete this.dependencies,this.sendCompleted(),i.schedule(e.DroppedPriority,this.ondropped.sendCompleted,this.ondropped)},r.prototype.reject=function(t){this.open&&this.rejectFirst(t)},r.prototype.rejectFirst=function(t){if(0===this.state){this.state=2,this.reason=t,delete this.value,e.plogger&&e.plogger.isSettled(this);var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onRejected(t)},this),this.sendError(t),delete this.dependencies,this.sendCompleted(),i.schedule(e.DroppedPriority,this.ondropped.sendCompleted,this.ondropped)}},r.prototype.dischargeDependency=function(t){1===this.state?t.onFulfilled(this.value):2===this.state&&t.onRejected(this.reason)},r.prototype.notify=function(t){this.open&&this.notifyFirst(t)},r.prototype.notifyFirst=function(t){if(0==this.state){this.value=t;var n=this.dependencies;i.schedule(e.PromisePriority,function(){for(var e=0,r=n.length;r>e;++e)n[e].onProgress(t)},this),this.sendNext(t)}},r.prototype.then=function(t,e,n){if("function"!=typeof t&&(t=null),"function"!=typeof e&&(e=null),"function"!=typeof n&&(n=null),t||e||n){var i=new r;return this.bindDependency(i,null,t,e,n),i}return this},r.prototype.catch=function(t){if("function"==typeof t){var e=new r;return this.bindDependency(e,null,null,t,null),e}return this},r.prototype.progress=function(t){if("function"==typeof t){var e=new r;return this.bindDependency(e,null,null,null,t),e}return this},r.prototype.onError=function(){},r.prototype.onCompleted=function(){},r.all=function(){if(arguments.length)for(var t=new r,e=[],i=0,o=arguments.length,s=function(n,r){e[n]=r,++i==o&&t.resolve(e)},a=0;a<arguments.length;++a)n(arguments[a],a,s);else var t=new r([]);return t},r}(e.BasicObservable));e.Promise=s,s.prototype.onFulfilled=s.prototype.resolveFirst,s.prototype.onRejected=s.prototype.rejectFirst,s.prototype.onProgress=s.prototype.notifyFirst,s.prototype.onNext=s.prototype.removeDependency,s.prototype.dependencies=[]}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(e){function n(){e.call(this);var n=new t.Promise;t.plogger&&t.plogger.register(n,"ladder","ladder initialization"),n.resolve(void 0),this.entries=[{promise:n,state:"fulfilled",value:void 0}]}return __extends(n,e),n.prototype.isSettled=function(){for(var t=this.entries.length-1;"failed"===this.entries[t].state;)--t;return"pending"!==this.entries[t].state},n.prototype.currentFailed=function(){return"failed"===this.entries[this.entries.length-1].state},n.prototype.getCurrentPromise=function(){return this.entries[this.entries.length-1].promise},n.prototype.forwardPromise=function(t){var e=this.entries.length-1;return this.tryToForward(t,e)||(t.ondropped.addObserver(this,this.onForwardDropped,null,null,this.entries[e].promise),this.entries[e].forwards?this.entries[e].forwards.push(t):this.entries[e].forwards=[t]),t},n.prototype.findPromiseIndex=function(t){for(var e=0,n=this.entries.length;n>e;++e)if(this.entries[e].promise===t)return e;return-1},n.prototype.getMostRecent=function(){for(var t=this.entries.length-1;t>=0;--t){var e=this.entries[t],n=e.state;if("fulfilled"===n||"rejected"===n||"pending"===n&&"value"in e)break}return t},n.prototype.addPromise=function(t){this.entries.push({promise:t,state:"pending"}),t.addDependency(this,this.onPromiseFulfilled,this.onPromiseRejected,this.onPromiseProgress,t)},n.prototype.onPromiseFulfilled=function(t,e){var n=this.findPromiseIndex(e);n>=0&&(this.entries[n].state="fulfilled",this.entries[n].value=t,this.getMostRecent()==n&&this.sendNext(t),this.updateForwardsStartingFrom(n))},n.prototype.onPromiseRejected=function(t,e){var n=this.findPromiseIndex(e);if(n>=0){if(null===t||void 0===t){this.entries[n].state="failed";var r=this.getMostRecent();if("value"in this.entries[n]&&n>r){var i=this.entries[r];this.sendNext("rejected"===i.state?i.reason:i.value)}else n==this.entries.length-1&&this.sendError(null)}else this.entries[n].state="rejected",this.entries[n].reason=t,this.getMostRecent()==n&&this.sendError(t);this.updateForwardsStartingFrom(n)}},n.prototype.onPromiseProgress=function(t,e){var n=this.findPromiseIndex(e);n>=0&&(this.entries[n].value=t,this.getMostRecent()==n&&this.sendNext(t),this.updateForwardsStartingFrom(n))},n.prototype.onForwardDropped=function(t,e){var n=this.findPromiseIndex(e),r=this.entries[n].forwards;if(n>=0&&r){var i=r.indexOf(t);i>=0&&(1==r.length?(this.entries[n].forwards=void 0,this.dropUnneededPromises()):r.splice(i,1))}},n.prototype.updateForwardsStartingFrom=function(t){this.tryToForwardList(t,t);for(var e=t+1,n=this.entries.length;n>e&&"failed"===this.entries[e].state;++e)this.tryToForwardList(e,t);this.dropUnneededPromises()},n.prototype.tryToForwardList=function(t,e){var n=this.entries[t].forwards;if(n){for(var r=[],i=0,o=n.length;o>i;++i)this.tryToForward(n[i],e)||r.push(n[i]);this.entries[t].forwards=0==r.length?void 0:r}},n.prototype.tryToForward=function(t,e){var n=this.entries[e];return"fulfilled"===n.state?(t.resolve(n.value),!0):"rejected"===n.state?(t.reject(n.reason),!0):"failed"===n.state?this.tryToForward(t,e-1):("pending"===n.state&&"value"in n&&t.notify(n.value),!1)},n.prototype.dropUnneededPromises=function(){for(var t=this.entries.length-1,e=!1,n=!1,r=t;r>=0;--r){var i=this.entries[r],o=i.state;"fulfilled"===o||"rejected"===o?(e&&this.entries.splice(r,1),e=!0,n=!0):i.forwards?e=!1:"failed"===o?r!=t&&this.entries.splice(r,1):"pending"===o&&n&&this.entries.splice(r,1)}},n}(t.BasicObservable);t.PromiseLadder=e}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t,e,i){return void 0===e&&(e=1),void 0===i&&(i=null),function(){for(var o=[],s=0;s<arguments.length;s++)o[s-0]=arguments[s];var a=new n(o,i),h=new r(t,a.promise,e);return h.outputPromises.length<=1?h.outputPromises[0]:h.outputPromises}}t.liftFunction=e;var n=function(){function e(e,n){this.values=[],this.numFulfilled=0;var r=e.length;if(this.inputs=e,this.values.length=r,this.promise=new t.Promise,t.plogger&&t.plogger.register(this.promise,"parampack","parameter pack"),this.promise.ondropped.addObserver(this),r)for(var i=0;r>i;++i)n&&n[i]?this.onParameterFulfilled(e[i],i):e[i].addDependency(this,this.onParameterFulfilled,this.onParameterRejected,this.onParameterProgress,i);else this.promise.resolve(this.values)}return e.prototype.onParameterFulfilled=function(t,e){this.values[e]=t,++this.numFulfilled==this.values.length?this.promise.resolve(this.values):this.promise.notify(this.values)},e.prototype.onParameterRejected=function(){this.promise.reject(null)},e.prototype.onParameterProgress=function(t,e){this.values[e]=t,this.promise.notify(this.values)},e.prototype.onNext=function(){this.inputs.forEach(function(t){t.removeDependency(this)
},this),this.promise.ondropped.removeObserver(this)},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.ParameterPack=n;var r=function(){function e(e,n,r){this.outputPromises=[],this.fn=e,this.parameters=n,n.addDependency(this);for(var i=0;r>i;++i){var o=new t.Promise;o.ondropped.addObserver(this),this.outputPromises.push(o)}}return e.prototype.onFulfilled=function(e){var n=this.outputPromises.length;try{var r=this.fn.apply(null,e);if(n>0)if(1==n)r=[r];else if(!Array.isArray(r))throw new TypeError("Multi-output lifted function did not return array");for(var i=0;n>i;++i)this.outputPromises[i].resolve(r[i]),r[i]instanceof t.Promise&&!r[i].isSettled()&&this.outputPromises[i].ondropped.addObserver(r[i])}catch(o){console.error(o);for(var i=0;n>i;++i)this.outputPromises[i].reject(o)}},e.prototype.onRejected=function(t){for(var e=this.outputPromises.length,n=0;e>n;++n)this.outputPromises[n].reject(t)},e.prototype.onProgress=function(){},e.prototype.onNext=function(){var t=this.outputPromises.some(function(t){return t.hasDependencies()});t||(this.parameters.removeDependency(this),this.outputPromises.forEach(function(t){t.reject(null)}))},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.SingleFunctionCall=r}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=function(){function t(){this.count=1,this.outstanding=[]}return t.prototype.register=function(t,e){t.id?console.error("Logging problem: attempt to re-register promise "+t.id):t.id=e+"#"+this.count++},t.prototype.checkId=function(t){t.id||this.register(t,"unknown")},t.prototype.nowHasDependencies=function(t){this.checkId(t),n.arraySet.add(this.outstanding,t),console.log("Promise expected: "+t.id)},t.prototype.lostAllDependencies=function(t){this.checkId(t),n.arraySet.remove(this.outstanding,t),console.log("Promise dropped:  "+t.id)},t.prototype.isSettled=function(t){this.checkId(t),n.arraySet.remove(this.outstanding,t),console.log("Promise settled:  "+t.id)},t.prototype.report=function(){return console.log(this.outstanding.length?"Outstanding: "+this.outstanding.map(function(t){return t.id}).join(", "):"No outstanding promises"),this.outstanding},t.prototype.activation=function(t,e){console.log("Activation: "+t.map(n.getId).join(", ")+" -> "+e.map(n.getId).join(", "))},t}();e.PromiseLogger=r}(e=t.reactive||(t.reactive={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(){this.visited={},this.collected=[];var t=this;this.collected.and=function(){return t}}return t.prototype.result=function(){return this.collected},t.prototype.collect=function(t,e){return Array.isArray(e)?e.forEach(function(e){this.collectRec(t,e)},this):this.collectRec(t,e),this.collected},t.prototype.collectRec=function(t,e){if(!this.visited[e]){this.visited[e]=!0,t>=0&&this.collected.push(e);var n=this.edges[e];for(var r in n)this.collectRec(-t,r)}},t}();t.DfsWalker=e}(e=t.graph||(t.graph={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(t){var e=function(){function t(){this.labels={},this.ins={},this.outs={}}return t.prototype.hasNode=function(t){return t in this.outs},t.prototype.hasEdge=function(t,e){return this.hasNode(t)&&this.outs[t][e]},t.prototype.getLabel=function(t){return this.labels[t]},t.prototype.setLabel=function(t,e){void 0===e?delete this.labels[t]:this.labels[t]=e},t.prototype.addNode=function(t,e){this.outs[t]||(void 0!==e&&(this.labels[t]=e),this.outs[t]={},this.ins[t]={})},t.prototype.addEdge=function(t,e){this.addNode(t),this.addNode(e),this.outs[t][e]=!0,this.ins[e][t]=!0},t.prototype.addEdgeTo=function(t){var e=this;return function(n){e.addEdge(n,t)}},t.prototype.addEdgeFrom=function(t){var e=this;return function(n){e.addEdge(t,n)}},t.prototype.removeNode=function(t){delete this.labels[t];for(var e in this.outs[t])delete this.ins[e][t];for(var n in this.ins[t])delete this.outs[n][t];delete this.outs[t],delete this.ins[t]},t.prototype.removeEdge=function(t,e){delete this.outs[t][e],delete this.ins[e][t]},t.prototype.getNodes=function(){return Object.keys(this.outs)},t.prototype.getLabeledNodes=function(){return Object.keys(this.labels)},t.prototype.getUnlabeledNodes=function(){return Object.keys(this.outs).filter(function(t){return!(t in this.labels)})},t.prototype.getOutsFor=function(t){var e=[],n=this.outs[t];for(var r in n)n[r]&&e.push(r);return e},t.prototype.getInsFor=function(t){var e=[],n=this.ins[t];for(var r in n)n[r]&&e.push(r);return e},t}();t.Digraph=e;var n=function(t){function e(e){t.call(this),this.digraph=e}return __extends(e,t),e.prototype.nodesDownstream=function(t){return this.edges=this.digraph.outs,this.collect(0,t)},e.prototype.nodesDownstreamSameType=function(t){return this.edges=this.digraph.outs,this.collect(1,t)},e.prototype.nodesDownstreamOtherType=function(t){return this.edges=this.digraph.outs,this.collect(-1,t)},e.prototype.nodesUpstream=function(t){return this.edges=this.digraph.ins,this.collect(0,t)},e.prototype.nodesUpstreamSameType=function(t){return this.edges=this.digraph.ins,this.collect(1,t)},e.prototype.nodesUpstreamOtherType=function(t){return this.edges=this.digraph.ins,this.collect(-1,t)},e}(t.DfsWalker);t.DigraphWalker=n}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=function(){function t(){this.graph=new e.Digraph}return t.prototype.constraintsFor=function(t){var e={};return t.forEach(function(t){e[this.graph.getLabel(t)]=!0},this),Object.keys(e)},t.prototype.addVariable=function(t){this.graph.addNode(t)},t.prototype.addMethod=function(t,e,n,r){this.graph.addNode(t,e),n.forEach(this.graph.addEdgeTo(t)),r.forEach(this.graph.addEdgeFrom(t))},t.prototype.removeVariable=function(t){this.graph.removeNode(t)},t.prototype.removeMethod=function(t){this.constraintForMethod(t);this.graph.removeNode(t)},t.prototype.variables=function(){return this.graph.getUnlabeledNodes()},t.prototype.methods=function(){return this.graph.getLabeledNodes()},t.prototype.constraints=function(){return this.constraintsFor(this.graph.getLabeledNodes())},t.prototype.contains=function(t){return this.graph.hasNode(t)},t.prototype.methodsWhichInput=function(t){return this.graph.getOutsFor(t)},t.prototype.methodsWhichOutput=function(t){return this.graph.getInsFor(t)},t.prototype.methodsWhichUse=function(t){var e=this.graph.getInsFor(t),r=this.graph.getOutsFor(t);return n.arraySet.union(e,r)},t.prototype.constraintsWhichInput=function(t){return this.constraintsFor(this.methodsWhichInput(t))},t.prototype.constraintsWhichOutput=function(t){return this.constraintsFor(this.methodsWhichOutput(t))},t.prototype.constraintsWhichUse=function(t){return this.constraintsFor(this.methodsWhichUse(t))},t.prototype.inputsForMethod=function(t){return this.graph.getInsFor(t)},t.prototype.outputsForMethod=function(t){return this.graph.getOutsFor(t)},t.prototype.variablesForMethod=function(t){var e=this.graph.getInsFor(t),r=this.graph.getOutsFor(t);return n.arraySet.union(e,r)},t.prototype.constraintForMethod=function(t){return this.graph.getLabel(t)},t.prototype.inputsForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getInsFor,this.graph);return r.reduce(n.arraySet.union,[])},t.prototype.outputsForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getOutsFor,this.graph);return r.reduce(n.arraySet.union,[])},t.prototype.variablesForConstraint=function(t){var e=this.methodsForConstraint(t),r=e.map(this.graph.getInsFor,this.graph),i=e.map(this.graph.getOutsFor,this.graph),o=r.reduce(n.arraySet.union,[]),s=i.reduce(n.arraySet.union,[]);return n.arraySet.union(o,s)},t.prototype.methodsForConstraint=function(t){return this.methods().filter(function(e){return this.graph.getLabel(e)==t},this)},t}();e.NoCachingConstraintGraph=r;var i=function(t){function e(){t.apply(this,arguments),this.vids={},this.cids={}}return __extends(e,t),e.prototype.addVariable=function(e){t.prototype.addVariable.call(this,e),this.vids[e]=!0},e.prototype.addMethod=function(e,r,i,o){t.prototype.addMethod.call(this,e,r,i,o),r in this.cids?n.arraySet.add(this.cids[r],e):this.cids[r]=[e]},e.prototype.removeVariable=function(e){delete this.vids[e],t.prototype.removeVariable.call(this,e)},e.prototype.removeMethod=function(e){var r=this.graph.getLabel(e),i=this.cids[r];n.arraySet.remove(i,e),0==i.length&&delete this.cids[r],t.prototype.removeMethod.call(this,e)},e.prototype.variables=function(){return Object.keys(this.vids)},e.prototype.constraints=function(){return Object.keys(this.cids)},e.prototype.methodsForConstraint=function(t){var e=this.cids[t];return e?n.arraySet.clone(e):[]},e}(r);e.CachingConstraintGraph=i}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.selectMethod=function(t,e,n,r){e||(e=null);var i=this.selectedForConstraint(t);i!=e&&(i&&this.removeMethod(i),e&&this.addMethod(e,t,n,r))},e.prototype.selectedForConstraint=function(t){var e,n=this.methodsForConstraint(t);return n&&(e=n[0]),e?e:null},e}(t.CachingConstraintGraph);t.CachingSolutionGraph=e}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(t){return t+"#sm"}function n(t){return t+"#sc"}function r(t){return"#sm"==t.substr(-3)}function i(t){return"#sm"!=t.substr(-3)}function o(t){return"#sc"==t.substr(-3)}function s(t){return"#sc"!=t.substr(-3)}t.stayMethod=e,t.stayConstraint=n,t.isStayMethod=r,t.isNotStayMethod=i,t.isStayConstraint=o,t.isNotStayConstraint=s}(e=t.graph||(t.graph={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){function e(e){var r=[];return t.debugIds&&r.push(e),r.push("#"),r.push(++n),r.join("")}t.debugIds=!0;var n=0;t.makeId=e}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=t.reactive,i=function(){function t(t,i,o){if(this.optional=2,this.error=new r.ScheduledSignal(null),this.stale=new r.ScheduledSignal(!1,n.doubleEqual),this.source=new r.ScheduledSignal(!1,n.doubleEqual),this.pending=new r.ScheduledSignal(!1,n.doubleEqual),this.contributing=new r.ScheduledSignal(1,n.doubleEqual),this.relevant=new r.ScheduledSignal(1,n.doubleEqual),this.changes=new r.BasicObservable,this.staged=null,this.id=e.makeId(t),this.name=t,this.value=new r.ScheduledSignal(void 0,o),this.ladder=new r.PromiseLadder,this.ladder.addObserver(this,this.onLadderNext,this.onLadderError,null),void 0!==i){var s;i instanceof r.Promise?s=i:(s=new r.Promise,r.plogger&&r.plogger.register(s,this.name,"variable initialization"),s.resolve(i)),this.makePromise(s)}this.setCommand=new e.Command("set "+t,void 0,[],[],[this])}return t.prototype.toString=function(){return this.name},t.prototype.makePromise=function(t){if(!(t instanceof r.Promise)){var e=t;t=new r.Promise,r.plogger&&r.plogger.register(t,this.name,"variable update"),t.resolve(e)}this.staged=t},t.prototype.commitPromise=function(){this.staged&&(this.ladder.addPromise(this.staged),this.staged=null,0==this.pending.get()&&(this.pending.set(!0),this.stale.set(!1),this.changes.sendNext({type:2,vv:this})))},t.prototype.getStagedPromise=function(){return this.staged||this.ladder.getCurrentPromise()},t.prototype.getCurrentPromise=function(){return this.ladder.getCurrentPromise()},t.prototype.getForwardedPromise=function(){var t=new r.Promise;return r.plogger&&r.plogger.register(t,this.name+"#fwd"," forwarded"),this.ladder.forwardPromise(t),t},t.prototype.get=function(){return this.value.get()},t.prototype.set=function(t){this.makePromise(t),this.changes.sendNext({type:0,vv:this})},t.prototype.commandSet=function(t){var e=Object.create(this.setCommand);e.result=t,this.changes.sendNext({type:4,vv:this,cmd:e})},t.prototype.addObserver=function(){return this.value.addObserver.apply(this.value,arguments)},t.prototype.removeObserver=function(t){return this.value.removeObserver(t)},t.prototype.onError=function(t){var e=new r.Promise;r.plogger&&r.plogger.register(e,this.name,"variable update"),e.reject(t),this.makePromise(e),this.changes.sendNext({type:0,vv:this})},t.prototype.onCompleted=function(){},t.prototype.onLadderNext=function(t){this.value.set(t),this.error.set(null),this.stale.set(this.ladder.currentFailed()),this.ladder.isSettled()&&(this.pending.set(!1),this.changes.sendNext({type:3,vv:this}))},t.prototype.onLadderError=function(t){null!==t&&this.error.set(t),this.stale.set(this.ladder.currentFailed()),this.ladder.isSettled()&&(this.pending.set(!1),this.changes.sendNext({type:3,vv:this}))},t}();e.Variable=i,i.prototype.onNext=i.prototype.commandSet}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){t.forwardPriorGens=!1}(e=t.config||(t.config={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e,n,r,i,o,s){this.external=!1,this.id=t.makeId(e),this.name=e,"function"==typeof n?this.fn=n:this.result=n,this.inputs=r,this.priorFlags=i,this.outputs=o,this.inputVars=s}return e.prototype.toString=function(){return this.name},e}();t.Method=e}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e,n,r){this.variables=[],this.methods=[],this.optional=0,this.id=t.makeId(e),this.name=e,this.variables=n,r&&r.length&&(this.touchVariables=r)}return e.prototype.toString=function(){return this.name},e.prototype.addMethod=function(t){this.methods.push(t)},e.WeakestStrength=Number.MIN_VALUE,e.RequiredStrength=Number.MAX_VALUE,e}();t.Constraint=e}(e=t.model||(t.model={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){function n(t){return t.constant}function r(t,e){for(var n=0,r=t.length,i=e.length;r>n&&i>n;++n)if(t[n]!==e[n]){var o=t[n].id.localeCompare(e[n].id);if(0!=o)return o}return r-i}function i(t,n){for(var r=0,i=t.length,o=n.length;i>r&&o>r;++r)if(t[r]!==n[r]){var s,a=t[r],h=n[r];if(s=(a instanceof e.Variable||a instanceof e.Constraint||a instanceof e.Command)&&(h instanceof e.Variable||h instanceof e.Constraint||h instanceof e.Command)?a.id.localeCompare(h.id):"number"==typeof a&&"number"==typeof h?a-h:"string"==typeof a&&"string"==typeof h?a.localeCompare(h):(a+"").localeCompare(h+""),0!=s)return s}return i-o}function o(t,e,n){for(var r=[],i=[],o=[],s=[],a=0,h=0,u=t.length,c=e.length;u>a&&c>h;){var d=n(t[a],e[h]);0>d?(r.push(t[a]),++a):d>0?(o.push(e[h]),++h):(i.push(t[a]),s.push(e[h]),++a,++h)}for(;u>a;)r.push(t[a]),++a;for(;c>h;)o.push(e[h]),++h;return{leftOnly:r,leftShared:i,rightOnly:o,rightShared:s}}function s(t){return t.element}var a=t.utility,h=t.reactive,u=function(){function t(t,e){this.from=t,this.to=e}return t}();e.TouchDep=u;var c=function(){function t(t){this.variable=t}return t}();e.Output=c;var d=function(t){function e(){t.apply(this,arguments),this.paths=[],this.instances=[],this.changed=!0}return __extends(e,t),e.prototype.addPath=function(t){a.arraySet.add(this.paths,t)&&(t.addObserver(this),(!this.master||this.master.cardinality<t.cardinality)&&(this.master=t))},e.prototype.addPaths=function(t){t.forEach(this.addPath,this)},e.prototype.isConstant=function(){return this.paths.every(n)},e.prototype.define=function(){throw"Attempt to call abstract method"},e.prototype.compare=function(){throw"Attempt to call abstract method"},e.prototype.create=function(){throw"Attempt to call abstract method"},e.prototype.addObserver=function(e,n,r,i,o){var s;return s=1==arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&this.changed&&s.onNext(this),s},e.prototype.update=function(t){var e=[];if(this.master)this.master.forEach(function(t,n){var r=this.define(n);r&&e.push(r)},this);else{var n=this.define(null);n&&e.push(n)}e.sort(this.compare);var r=o(this.instances,e,this.compare);r.leftOnly.length>0&&t.removes.push.apply(t.removes,r.leftOnly.map(s));for(var i=0,a=r.leftShared.length;a>i;++i)r.rightShared[i].element=r.leftShared[i].element;r.rightOnly.length>0&&r.rightOnly.forEach(function(e){this.create(e),t.adds.push(e.element)},this),this.instances=e,this.changed=!1},e.prototype.getElements=function(){return this.instances.map(s)},e.prototype.onNext=function(){this.changed||(this.changed=!0,this.sendNext(this))},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e.prototype.destruct=function(){for(var t=0,e=this.paths.length;e>t;++t)this.paths[t].removeObserver(this)},e}(h.BasicObservable),p=function(){function t(t,e){this.inputs=t.inputs.map(e.get,e),t.priorFlags&&(this.priorFlags=t.priorFlags.slice(0)),this.outputs=t.outputs.map(e.get,e),this.fn=t.fn,this.name=[t.inputs.join(","),t.outputs.join(",")].join("->")}return t.prototype.define=function(t){for(var n=function(e){return e.get(t)},r=this.inputs.map(n),i=this.outputs.map(n),o=0,s=r.length;s>o;++o)if(r[o]instanceof e.Variable&&(!this.priorFlags||!this.priorFlags[o])&&i.indexOf(r[o])>=0)return console.warn("Method cannot be instantiated with same variable as input and output: "+this.name),null;var h=a.arraySet.fromArray(i.filter(a.isType(e.Variable)));return i.length!=h.length?(console.warn("Method cannot be instantiated with non-variable or duplicate outputs: "+this.name),null):{inputs:r,outputs:i}},t.prototype.create=function(t,n){return new e.Method(this.name,this.fn,t.inputs,this.priorFlags,t.outputs,a.arraySet.difference(n,t.outputs))},t}(),l=function(){function t(t,e,n,r){this.all=t,this.variables=e,this.methods=n,this.touchVariables=r}return t}(),f=function(t){function n(e,n){t.call(this),this.addPaths(this.variables=e.variables.map(n.get,n)),this.methods=e.methods.map(function(t){return new p(t,n)}),this.optional=e.optional,e.touchVariables&&e.touchVariables.length&&this.addPaths(this.touchVariables=e.touchVariables.map(n.get,n)),this.name=e.variables.join(",")}return __extends(n,t),n.prototype.define=function(t){for(var n=[],r=[],i=0,o=this.variables.length;o>i;++i){var s=this.variables[i].get(t);if(void 0===s)return null;n.push(s),s instanceof e.Variable&&r.push(s)}for(var h=[],u=!1,i=0,o=this.methods.length;o>i;++i){var c=this.methods[i].define(t);c&&(h[i]=c,u=!0)}if(u){var d;if(this.touchVariables&&this.touchVariables.length){d=[];for(var i=0,o=this.touchVariables.length;o>i;++i){var s=this.touchVariables[i].get(t);s instanceof e.Variable&&a.arraySet.add(d,s)}}return new l(n,r,h,d)}return null},n.prototype.compare=function(t,e){var n=i(t.all,e.all);return 0==n&&t.touchVariables&&(n=i(t.touchVariables,e.touchVariables)),n},n.prototype.create=function(t){var n=new e.Constraint(this.name,t.variables,t.touchVariables);n.optional=this.optional;for(var r=0,i=t.methods.length;i>r;++r)t.methods[r]&&n.addMethod(this.methods[r].create(t.methods[r],t.variables));t.element=n},n}(d),v=function(){function t(t,e){this.inputs=t,this.outputs=e}return t}(),g=function(t){function n(e,n){t.call(this),this.addPaths(this.inputs=e.inputs.map(n.get,n)),e.priorFlags&&(this.priorFlags=e.priorFlags.slice(0)),this.addPaths(this.outputs=e.outputs.map(n.get,n)),this.fn=e.fn,this.synchronous=e.synchronous,this.name=[e.inputs.join(","),e.outputs.join(",")].join("->"),this.activate=this.activate.bind(this)}return __extends(n,t),n.prototype.define=function(t){var n=function(e){return e.get(t)},r=this.inputs.map(n),i=this.outputs.map(n);if(r.some(a.isUndefined)||i.some(a.isUndefined))return null;for(var o=0,s=r.length;s>o;++o)if(r[o]instanceof e.Variable&&(!this.priorFlags||!this.priorFlags[o])&&i.indexOf(r[o])>=0)return console.warn("Command cannot be instantiated with same variable as input and output: "+this.name),null;var h=a.arraySet.fromArray(i.filter(a.isType(e.Variable)));return h.length!=i.length?(console.warn("Command cannot be instantiated with non-variable or duplicate outputs: "+this.name),null):new v(r,i)},n.prototype.compare=function(t,e){var n=i(t.inputs,e.inputs);return 0==n&&(n=r(t.outputs,e.outputs)),n},n.prototype.create=function(t){t.element=this.synchronous?new e.SynchronousCommand(this.name,this.fn,t.inputs,this.priorFlags,t.outputs):new e.Command(this.name,this.fn,t.inputs,this.priorFlags,t.outputs)},n.prototype.activate=function(){var t=this.getElements();t.length&&t[0].activate()},n}(d),m=function(){function t(t,e){this.from=t,this.to=e}return t}(),y=function(t){function n(e,n){t.call(this),this.addPath(this.from=n.get(e.from)),this.addPath(this.to=n.get(e.to)),this.name=this.from+"=>"+this.to}return __extends(n,t),n.prototype.define=function(t){var n=this.from.get(t),r=this.to.get(t);return n!==r&&(n instanceof e.Variable||n instanceof e.Constraint)&&(r instanceof e.Variable||r instanceof e.Constraint)?new m(n,r):null},n.prototype.compare=function(t,e){var n=t.from.id.localeCompare(e.from.id);return 0==n&&(n=t.to.id.localeCompare(e.to.id)),n},n.prototype.create=function(t){t.element=new u(t.from,t.to)},n}(d),b=function(){function t(t){this.variable=t}return t}(),x=function(t){function n(e,n){t.call(this),this.addPath(this.variable=n.get(e.variable)),this.name="@"+e.variable}return __extends(n,t),n.prototype.define=function(t){var n=this.variable.get(t);return n instanceof e.Variable?new b(n):void 0},n.prototype.compare=function(t,e){return t.variable.id.localeCompare(e.variable.id)},n.prototype.create=function(t){t.element=new c(t.variable)},n}(d),w=function(t){function n(e){t.call(this),this.elements=[],this.templates=[],this.added=[],this.removed=[],this.outdated=[],this.changed=!1,this.paths={},this.context=e}return __extends(n,t),n.prototype.reportChanged=function(){this.changed||(this.changed=!0,this.sendNext(this.context))},n.prototype.getElements=function(){return this.elements.concat(a.concatmap(this.templates,function(t){return t.getElements()}))},n.prototype.addStatic=function(t){var e=!1;return a.arraySet.remove(this.removed,t)&&(e=!0),!a.arraySet.contains(this.elements,t)&&a.arraySet.add(this.added,t)&&(e=!0,this.reportChanged()),e},n.prototype.removeStatic=function(t){var e=!1;return a.arraySet.remove(this.added,t)&&(e=!0),a.arraySet.contains(this.elements,t)&&a.arraySet.add(this.removed,t)&&(e=!0,this.reportChanged()),e},n.prototype.addTemplate=function(t){if(t.isConstant()){var e={removes:[],adds:[]};t.update(e),e.adds.length>0?e.adds.forEach(this.addStatic,this):console.warn("Could not instantiate constant template: ")}else a.arraySet.add(this.templates,t)&&t.addObserver(this)},n.prototype.update=function(){var t=this.removed;this.removed=[],t.length>0&&(this.elements=a.arraySet.difference(this.elements,t));var e=this.added;this.added=[],e.length>0&&Array.prototype.push.apply(this.elements,e);var n={adds:e,removes:t};if(this.outdated.length>0){for(var r=0,i=this.outdated.length;i>r;++r)this.outdated[r].update(n);this.outdated=[]}return this.changed=!1,n},n.prototype.onNext=function(t){this.outdated.push(t),this.reportChanged()},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n.prototype.get=function(t){var n=this.paths[t];return n||(n=this.paths[t]=new e.Path(this.context,t)),n},n.prototype.addObserver=function(e,n,r,i,o){var s;return s=1==arguments.length?t.prototype.addObserver.call(this,e):t.prototype.addObserver.call(this,e,n,r,i,o),s&&this.changed&&s.onNext(this.context),s},n}(h.BasicObservable),C=function(){function t(e,n){e&&t.construct(this,e,n)}return t.construct=function(e,n,r){if(r){if("object"!=typeof r)throw"Invalid initialization object passed to Context.construct: "+r}else r={};for(var i=0,o=n.constants.length;o>i;++i){var s=n.constants[i];s.loc in e||t.addConstant(e,n.constants[i])}for(var a=(n.variables.filter(function(t){return!(t.loc in e)})),i=a.length-1;i>=0;--i){var h=a[i];(2===h.optional&&(void 0!==h.init||void 0!==r[h.loc])||0===h.optional&&void 0===r[h.loc]&&void 0!==h.init)&&t.addVariable(e,h,r[h.loc])}for(var i=a.length-1;i>=0;--i){var h=a[i];0!==h.optional&&2!==h.optional||void 0!==h.init||void 0!==r[h.loc]||t.addVariable(e,h,r[h.loc])}for(var i=0,o=a.length;o>i;++i){var h=a[i];1===h.optional&&void 0===h.init&&void 0===r[h.loc]&&t.addVariable(e,h,r[h.loc])}for(var i=0,o=a.length;o>i;++i){var h=a[i];(1===h.optional&&(void 0!==h.init||void 0!==r[h.loc])||0===h.optional&&void 0!==r[h.loc])&&t.addVariable(e,h,r[h.loc])}for(var i=0,o=n.nesteds.length;o>i;++i){var u=n.nesteds[i];u.loc in e||t.addNestedContext(e,u,r[u.loc])}for(var i=0,o=n.references.length;o>i;++i){var c=n.references[i];c.loc in e||t.addReference(e,c,r[c.loc])}for(var i=0,o=n.constraints.length;o>i;++i)t.addConstraint(e,n.constraints[i]);for(var i=0,o=n.commands.length;o>i;++i)t.addCommand(e,n.commands[i]);for(var i=0,o=n.touchDeps.length;o>i;++i)t.addTouchDep(e,n.touchDeps[i]);for(var i=0,o=n.outputs.length;o>i;++i)t.addOutput(e,n.outputs[i]);return e},t.addConstant=function(t,e){t[e.loc]=e.value},t.addVariable=function(t,n,r){var i=t["#hd_data"],o=new e.Variable(n.loc,void 0===r?n.init:r,n.eq);o.optional=0!==n.optional?n.optional:void 0===r?2:1,i.addStatic(o),t[n.loc]=o},t.addNestedContext=function(e,n){var r,i=e["#hd_data"];r=n.klass?new n.klass:new t,n.spec&&t.construct(r,n.spec),i.addStatic(r),e[n.loc]=r},t.addReference=function(e,n,r){var i=new h.BasicSignal(r,n.eq);t.defineReferenceAccessors(e,n.loc,i)},t.defineReferenceAccessors=function(t,e,n){Object.defineProperty(t,"$"+e,{configurable:!0,enumerable:!1,value:n}),Object.defineProperty(t,e,{configurable:!0,enumerable:!0,get:n.get.bind(n),set:n.set.bind(n)})},t.addConstraint=function(t,e){var n=t["#hd_data"],r=new f(e,n);n.addTemplate(r),e.loc&&(t[e.loc]=r)},t.addCommand=function(t,e){var n=t["#hd_data"],r=new g(e,n);n.addTemplate(r),e.loc&&r.isConstant()&&(t[e.loc]=r.instances[0].element)},t.addTouchDep=function(t,e){var n=t["#hd_data"];n.addTemplate(new y(e,n))},t.addOutput=function(t,e){var n=t["#hd_data"];n.addTemplate(new x(e,n))},t.update=function(t){var e=t["#hd_data"];return e.update()},t.changes=function(t){return t["#hd_data"]},t.elements=function(t){var e=t["#hd_data"];return e.getElements()},t.claim=function(t,e){var n=t["#hd_data"];return n.addStatic(e)},t.release=function(t,e){var n=t["#hd_data"];return n.removeStatic(e)},t.destruct=function(t){for(var e=t["#hd_data"],n=0,r=e.templates.length;r>n;++n)e.templates[n].destruct()},t}();e.Context=C,Object.defineProperty(C.prototype,"#hd_data",{get:function(){var t=new w(this);return Object.defineProperty(this,"#hd_data",{configurable:!0,enumerable:!1,value:t}),t}})}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e;!function(t){function e(t){function e(){var t=c[d++];if(t.match(/^\.?\d/))return new i(t);if(t.match(/^[\w\.$]+$/)){if(t in l)throw"Encountered duplicate variable: '"+t+"'";return l[t]="v"+ ++p,new o(l[t])}if("-"===t){var n=e();return new s("-",n)}if("("===t){if(n=r(),t=c[d++],")"!==t)throw"Expected ')' but found '"+t+"''";return n}throw"Expected value but found '"+t+"'"}function n(){for(var t=e(),n=c[d];"*"===n||"/"===n;){++d;var r=e();t=new a(t,n,r),n=c[d]}return t}function r(){for(var t=n(),e=c[d];"+"===e||"-"===e;){++d;var r=n();t=new a(t,e,r),e=c[d]}return t}function u(){var t=r(),e=c[d++];if(!e||!e.match(/^[<>=]=$/))throw"Expected equality but found '"+e+"'";var n=r();return new h(t,e,n,l)}var c=t.match(/((\d+(\.\d*)?)|(\.\d+))([eE][+-]?\d+)?|[\w\.$]+|[<>=]=|\S/g),d=0,p=0,l={},f=u();if(d===c.length)return f;throw"Unexpected token after equation ended: '"+c[d]+"'"}function n(t,e,n){var i=function(t){if(t in n.vars)return n.vars[t];throw"Unknown variable '"+t+"'"};t=t.map(i),e=i(e);var s=r(n,e);if(s){var a,h=[],u=1;do{do a="d"+u++;while(a==e||t.indexOf(a)>=0);var c=s.extractDivisor(a);c&&(c instanceof o?h.push("if ("+c.name+' == 0) throw "Division by zero";'):(h.push("var "+a+" = "+c.print()+";"),h.push("if ("+a+' == 0) throw "Division by zero";')))}while(c);"=="==n.op?h.push("return "+s.print()+";"):(h.push("if ("+n.left.print()+n.op+n.right.print()+")"),h.push("  return "+e+";"),h.push("else"),h.push("  return "+s.print()+";"));var d=h.join("\n"),p=[null].concat(t);return p.push(d),new(Function.bind.apply(Function,p))}return null}function r(t,e){function n(t,e){if(0==r.length)return e;if(t instanceof s){var i=t;return r.shift(),n(i.expr,new s(i.op,e))}if(t instanceof a){var o=t;if("+"===o.op)return"left"===r.shift()?n(o.left,new a(e,"-",o.right)):n(o.right,new a(e,"-",o.left));if("-"===o.op)return"left"===r.shift()?n(o.left,new a(e,"+",o.right)):n(o.right,new a(o.left,"-",e));if("*"===o.op)return"left"===r.shift()?n(o.left,new a(e,"/",o.right)):n(o.right,new a(e,"/",o.left));if("/"===o.op)return"left"===r.shift()?n(o.left,new a(e,"*",o.right)):n(o.right,new a(o.left,"/",e))}}var r=t.left.find(e);return r?n(t.left,t.right):(r=t.right.find(e),r?n(t.right,t.left):null)}var i=function(){function t(t){this.text=t}return t.prototype.print=function(){return this.text},t.prototype.hasVar=function(){return!1},t.prototype.find=function(){return null},t.prototype.extractDivisor=function(){return null},t}();t.Number=i;var o=function(){function t(t){this.name=t}return t.prototype.print=function(){return this.name},t.prototype.hasVar=function(){return!0},t.prototype.find=function(t){return this.name==t?[]:null},t.prototype.extractDivisor=function(){return null},t}();t.Variable=o;var s=function(){function t(t,e){this.op=t,this.expr=e}return t.prototype.print=function(){return"("+this.op+this.expr.print()+")"},t.prototype.hasVar=function(){return this.expr.hasVar()},t.prototype.find=function(t){var e=this.expr.find(t);return e&&e.unshift("expr"),e},t.prototype.extractDivisor=function(t){return this.expr.extractDivisor(t)},t}();t.UnaryOperation=s;var a=function(){function t(t,e,n){this.left=t,this.op=e,this.right=n,this.extracted=!1}return t.prototype.print=function(){return"("+this.left.print()+this.op+this.right.print()+")"},t.prototype.hasVar=function(){return this.left.hasVar()||this.right.hasVar()},t.prototype.find=function(t){var e=this.left.find(t);return e?e.unshift("left"):(e=this.right.find(t),e&&e.unshift("right")),e},t.prototype.extractDivisor=function(t){var e=this.right.extractDivisor(t);return e||(e=this.left.extractDivisor(t),e||"/"!=this.op||this.extracted||(this.right.hasVar()&&(e=this.right,this.right instanceof o||(this.right=new o(t))),this.extracted=!0)),e},t}();t.BinaryOperation=a;var h=function(){function t(t,e,n,r){this.left=t,this.op=e,this.right=n,this.vars=r}return t}();t.Equation=h,t.parse=e,t.makeFunction=n}(e=t.eqn||(t.eqn={}))}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return t.match(/^[a-zA-Z][\w$]*(\.[a-zA-Z][\w$]*|\[\s*(\d+|\*)\s*\]|\[\s*(\d+\s*)?[a-zA-Z][\w$]*\s*([+-]\s*\d+\s*)?\])*$/)?!1:(console.error('Invalid variable path: "'+t+'"'),!0)}function r(t){var e,n,r=t.trim().split(/\s*=>\s*/);if(1==r.length)n=r[0].split(/\s*,\s*/);else{if(2!=r.length)return console.error('Invalid constraint signature: "'+t+'"'),null;e=r[0].split(/\s*,\s*/),n=r[1].split(/\s*,\s*/)}return{touchVars:e,constraintVars:n}}function i(t,e){var n=e.trim().split(/\s*->\s*/);if(2!=n.length)return console.error("Invalid "+t+' signature: "'+e+'"'),null;for(var r=""==n[0]?[]:n[0].split(/\s*,\s*/),i=""==n[1]?[]:n[1].split(/\s*,\s*/),s=[],a=[],h=0,u=r.length;u>h;++h){var c=o(r[h],["*","!"]);if(!c)return null;r[h]=c.name,c["*"]&&(s[h]=!0),c["!"]&&(a[h]=!0)}return{inputs:r,promiseFlags:0==s.length?null:s,priorFlags:0==a.length?null:a,outputs:i}}function o(t,e){for(var n={},r=t.charAt(0);!r.match(/\w/);){if(e.indexOf(r)>=0){if(n[r])return console.error("Duplicate variable prefix: "+r),null;n[r]=!0}else if(!r.match(/\s/))return console.error("Invalid variable prefix: "+r),null;t=t.substring(1),r=t.charAt(0)}return n.name=t,n}var s=t.utility,a=t.reactive,h=function(){function t(){this.target={constants:[],variables:[],nesteds:[],references:[],constraints:[],commands:[],outputs:[],touchDeps:[]},this.lastConstraint=null,this.lastVariables=null,this.usedLocs={}
}return t.prototype.spec=function(){return this.endAll(),this.target},t.prototype.context=function(t){return this.endAll(),new e.Context(this.target,t)},t.prototype.constant=function(t,e){return this.target.constants.push({loc:t,value:e}),this},t.prototype.variable=function(t,e,n){if(this.endAll(),this.invalidLoc(t))return this;if(n&&"function"!=typeof n)return console.error("Variable equality predicate must be a function"),this;var r={loc:t,init:e,optional:0,eq:n};return this.target.variables.push(r),this.usedLocs[t]=!0,this.lastVariables=r,this},t.prototype.variables=function(){this.endAll();var t,e;"string"==typeof arguments[0]?(t=arguments[0].trim().split(/\s*,\s*/),e=arguments[1]||{}):(e=arguments[0],t=Object.keys(e));for(var n=[],r=0,i=t.length;i>r;++r){var o=t[r];this.variable(o,e[o]),this.lastVariables&&n.push(this.lastVariables)}return this.lastVariables=n.length>0?n:null,this},t.prototype.nested=function(t,e,n){return this.endAll(),this.invalidLoc(t)?this:(this.target.nesteds.push({loc:t,klass:e,spec:n}),this.usedLocs[t]=!0,this)},t.prototype.reference=function(t,e){return this.endAll(),this.invalidLoc(t)?this:(this.target.references.push({loc:t,eq:e}),this.usedLocs[t]=!0,this)},t.prototype.references=function(t){return t.trim().split(/\s*,\s*/).forEach(function(t){this.reference(t)},this),this},t.prototype.constraint=function(){this.endAll();var t,e;arguments.length>1?(t=arguments[0],e=arguments[1]):e=arguments[0];var i=r(e);return null==i?this:i.constraintVars.some(n)||i.touchVars&&i.touchVars.some(n)?this:(this.lastConstraint={variables:i.constraintVars,methods:[],optional:0},i.touchVars&&(this.lastConstraint.optional=1,this.lastConstraint.touchVariables=i.touchVars),t&&!this.invalidLoc(t)&&(this.lastConstraint.loc=t,this.usedLocs[this.lastConstraint.loc]=!0),this)},t.prototype.endConstraint=function(){return this.lastConstraint&&(this.target.constraints.push(this.lastConstraint),this.lastConstraint=null),this},t.prototype.endVariables=function(){return this.lastVariables=null,this},t.prototype.endAll=function(){return this.endConstraint(),this.endVariables(),this},t.prototype.method=function(t,e,n){if(void 0===n&&(n=!0),!this.lastConstraint)return console.error('Builder function "method" called with no constraint'),this;var r=i("method",t);if(null==r)return this;var o=this.lastConstraint.variables,h=function(e){return o.indexOf(e)<0?(console.error("Variable "+e+" does not belong to constraint in method "+t),!0):!1};return r.inputs.some(h)||r.outputs.some(h)?this:(s.arraySet.addKnownDistinct(this.lastConstraint.methods,{inputs:r.inputs,priorFlags:r.priorFlags,outputs:r.outputs,fn:n?a.liftFunction(e,r.outputs.length,r.promiseFlags):e}),this)},t.prototype.optional=function(t){if(void 0===t&&(t=1),this.lastConstraint)this.lastConstraint.optional=t;else if(this.lastVariables)if(Array.isArray(this.lastVariables))for(var e=this.lastVariables,n=0,r=e.length;r>n;++n)e[n].optional=t;else this.lastVariables.optional=t;else console.error("Call to optional must follow constraint or variable");return this},t.prototype.command=function(t,e,r,o,s){if(void 0===o&&(o=!0),void 0===s&&(s=!1),this.endAll(),this.invalidLoc(t))return this;var h=i("method",e);return null==h?this:h.inputs.some(n)||h.outputs.some(n)?this:(this.target.commands.push({loc:t,inputs:h.inputs,priorFlags:h.priorFlags,outputs:h.outputs,fn:o?a.liftFunction(r,h.outputs.length,h.promiseFlags):r,synchronous:s}),this)},t.prototype.syncommand=function(t,e,n,r){return void 0===r&&(r=!0),this.command(t,e,n,r,!0)},t.prototype.output=function(t){return this.endAll(),n(t)?this:(this.target.outputs.push({variable:t}),this)},t.prototype.outputs=function(t){return t.trim().split(/\s*,\s*/).forEach(this.output,this),this},t.prototype.touchDep=function(){this.endAll();var t,e;if(1==arguments.length){var r=arguments[0].trim().split(/\s*=>\s*/);if(2!=r.length)return console.error('Invalid touch dependency signature: "'+arguments[0]+'"'),this;t=r[0],e=r[1]}else t=arguments[0],e=arguments[1];return n(t)||n(e)?this:(this.target.touchDeps.push({from:t,to:e}),this)},t.prototype.equation=function(t){this.endAll();try{var r=e.eqn.parse(t),i=Object.keys(r.vars);if(i.some(n))return this;for(var o,h={variables:i,methods:[],optional:0},u=function(t){return t!==o},c=0,d=i.length;d>c;++c){o=i[c];var p,l=void 0;"=="===r.op?p=i.filter(u):(p=i,l=[],l[c]=!0);var f=(p.join(",")+"->"+o,e.eqn.makeFunction(p,o,r)),v={inputs:p,outputs:[o],priorFlags:l,fn:a.liftFunction(f)};s.arraySet.addKnownDistinct(h.methods,v)}this.target.constraints.push(h)}catch(g){console.error(g)}return this},t.prototype.invalidLoc=function(t){return t.match(/^[a-zA-Z][\w$]*$/)?this.usedLocs[t]?(console.error('Cannot redefine context property: "'+t+'"'),!0):!1:(console.error('Invalid context property name: "'+t+'"'),!0)},t}();e.ContextBuilder=h,h.prototype.v=h.prototype.variable,h.prototype.vs=h.prototype.variables,h.prototype.n=h.prototype.nested,h.prototype.r=h.prototype.reference,h.prototype.rs=h.prototype.references,h.prototype.c=h.prototype.constraint,h.prototype.m=h.prototype.method,h.prototype.o=h.prototype.output,h.prototype.os=h.prototype.outputs,h.prototype.td=h.prototype.touchDep,h.prototype.eq=h.prototype.equation}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){s=t}function r(t){for(var e=t,n=/\S/,r=/^\s*\.?([a-zA-Z][\w$]*)/,i=/^\s*\[\s*(\d+)\s*\]/,a=/^\s*\[\s*(?:(\d+)\s*\*\s*)?([a-zA-Z][\w$]*)\s*(?:([+-])\s*(\d+)\s*)?\]/,h=[];n.test(e);){var u;if(u=r.exec(e))h.push(u[1]);else if(u=i.exec(e))h.push(new o(0,Number(u[1])));else{if(!(u=a.exec(e)))return console.error('Unable to parse path "'+t+'"'),null;if(u[2]!=s)return console.error('Unknown array index in "'+t+'"'),null;var c=1,d=0;u[1]&&(c=Number(u[1])),u[4]&&(d=Number(u[4]),"-"==u[3]&&(d=-d)),h.push(new o(c,d))}e=e.substr(u[0].length)}return h}var i=t.reactive,o=function(){function t(t,e){this.scale=t,this.offset=e}return t.prototype.apply=function(t){return 0==this.scale?this.offset:null===t?void 0:this.scale*t+this.offset},t.prototype.inverse=function(t){if(null===t)return void 0;if(0==this.scale)return t===this.offset?null:void 0;var e=(t-this.offset)/this.scale;return Math.floor(e)===e?e:void 0},t}();e.IndexPattern=o;var s;n("i");var a=function(){function t(t,e,n,r){this.path=t,this.property=e,this.legi=n,this.pos=r,this.property.addObserverChangesOnly(this)}return t.prototype.destruct=function(){this.property.removeObserver(this)},t.prototype.onNext=function(){this.path.onNextProperty(this.legi,this.pos)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}(),h=function(){function t(t,e,n,r){this.path=t,this.ctx=e,this.legi=n,this.pos=r,this.ctx.changes.addObserver(this)}return t.prototype.destruct=function(){this.ctx.changes.removeObserver(this)},t.prototype.onNext=function(t){this.path.onNextArray(t,this.legi,this.pos)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}(),u=function(t){function n(e,n){if(t.call(this),this.constant=!0,this.branchi=0,this.observers0=null,this.observers1=null,this.legs=r(n),this.legs){this.start=e,this.cardinality=0;for(var i=0,s=this.legs.length;s>i;++i)if(this.legs[i]instanceof o&&0!=this.legs[i].scale){this.branchi=i+1,this.cardinality=1,this.result=[];break}}else this.start=void 0,this.legs=[],this.cardinality=0;this.followPath(this.start,0,null)}return __extends(n,t),n.prototype.get=function(t){return 0==this.cardinality?this.result:null!==t?this.result[t]:void 0},n.prototype.addResult=function(t,e){0==this.cardinality?(this.result=e,this.sendNext(null)):null!==t&&(this.result[t]=e,this.sendNext(t))},n.prototype.removeResult=function(t){if(0==this.cardinality)void 0!==this.result&&(this.result=void 0,this.sendNext(t));else if(null!==t)void 0!==this.result[t]&&(this.result[t]=void 0,this.sendNext(t));else{for(var e=0,n=this.result.length;n>e;++e)void 0!==this.result[e]&&this.sendNext(e);this.result=[]}},n.prototype.getUpTo=function(t,n,r,i){for(void 0===r&&(r=this.start),void 0===i&&(i=0);t>=i&&r instanceof e.Context;++i){var s=this.legs[i];if("string"==typeof s)r=r[s];else if(s instanceof o){var a=s.apply(n);r=void 0===a?void 0:r[a]}}return i>t?r:void 0},n.prototype.addLegObserver=function(t,e,n){this.constant=!1,null===n?(this.observers0||(this.observers0=[]),this.observers0[e]=t):(this.observers1||(this.observers1=[]),this.observers1[n]||(this.observers1[n]=[]),this.observers1[n][e-this.branchi]=t)},n.prototype.removeLegObservers=function(t,e){if(null===e){if(this.observers0)for(var n=t,r=this.observers0.length;r>n;++n){var i=this.observers0[n];i&&(i.destruct(),this.observers0[n]=void 0)}if(this.observers1)for(var n=0,r=this.observers1.length;r>n;++n){var o=this.observers1[n];if(o)for(var s=0,a=o.length;a>s;++s){var i=o[s];i&&(i.destruct(),o[s]=void 0)}}}else if(this.observers1){var o=this.observers1[e];if(o)for(var s=t-this.branchi,a=o.length;a>s;++s){var i=o[s];i&&(i.destruct(),o[s]=void 0)}}},n.prototype.followPath=function(t,n,r){for(var i=this.legs.length;i>n&&t instanceof e.Context;++n){var s=this.legs[n];if("string"==typeof s){var u="$"+s;if(u in t){var c=t[u];this.addLegObserver(new a(this,c,n,r),n,r),t=c.get()}else t=t[s]}else if(s instanceof o&&t instanceof e.ArrayContext){if(0!=s.scale&&null===r){this.addLegObserver(new h(this,t,n,r),n,r);for(var d=0,p=t.length;p>d;++d)if(void 0!==t[d]){var l=s.inverse(d);void 0!==l&&this.followPath(t[d],n+1,l)}break}var f=s.apply(r);this.addLegObserver(new h(this,t,n,r),n,r),t=t[f]}}i==n&&void 0!==t&&this.addResult(r,t)},n.prototype.onNextProperty=function(t,e){this.removeResult(e),this.removeLegObservers(t+1,e),this.followPath(this.getUpTo(t,e),t+1,e)},n.prototype.onNextArray=function(t,e,n){var r=!1,i=this.legs[e];0==i.scale?i.offset===t&&(r=!0):null!==n?i.apply(n)===t&&(r=!0):(n=i.inverse(t),r=!0),r&&(this.removeResult(n),this.removeLegObservers(e+1,n),this.followPath(this.getUpTo(e,n),e+1,n))},n.prototype.forEach=function(t,n){if(void 0===n&&(n=null),0==this.cardinality)void 0!==this.result&&t.call(n,this.result,null);else{var r=this.legs.length-1,i=this.legs[this.branchi-1],o=this.getUpTo(this.branchi-2,null);if(o instanceof e.ArrayContext)for(var s=0,a=o.length;a>s;++s)if(void 0!==o[s]){var h=i.inverse(s);if(null!==h){var u=this.getUpTo(r,h,o[s],this.branchi);u&&t.call(n,u,h)}}}},n}(i.BasicObservable);e.Path=u,e.parse=r;var c=function(t){function e(e){t.call(this),this.path=e,e.addObserver(this,this.onPositionChange,null,null),this.set(e.get(null))}return __extends(e,t),e.prototype.onPositionChange=function(){this.set(this.path.get(null))},e}(i.BasicSignal);e.PathValue=c}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function n(n,r,i,o,s){t.call(this),this.external=!0,this.id=e.makeId(n),this.name=n,"function"==typeof r?this.fn=r:this.result=r,this.inputs=i,this.priorFlags=o,this.outputs=s}return __extends(n,t),n.prototype.onNext=function(){this.sendNext(this)},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(n.BasicObservable);e.Command=r,r.prototype.activate=r.prototype.onNext;var i=function(t){function e(e){t.call(this),this.cache=[],this.observables=e,this.cache.length=e.length;for(var n=0,r=0,i=e.length;i>r;++r)e[r].addObserver(this,this.onNext,null,null,n++)}return __extends(e,t),e.prototype.onNext=function(t,e){this.cache[e]=t?!0:!1;for(var n=!0,r=0,i=this.cache.length;i>r;++r){if(void 0===this.cache[r])return;n=n&&!this.cache[r]}this.set(n)},e}(n.BasicSignal);e.None=i;var o=function(t){function e(e,n,r,o,s){t.call(this,e,n,r,o,s);for(var a=[],h=0,u=r.length;u>h;++h){var c=r[h];a.push(c.pending),a.push(c.error)}this.ready=new i(a)}return __extends(e,t),e.prototype.onNext=function(){this.ready.get()&&this.sendNext(this)},e}(r);e.SynchronousCommand=o,o.prototype.activate=o.prototype.onNext}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return function(){return this.get(t)}}function r(t){return function(e){this.set(t,e)}}var i=t.utility,o=t.reactive,s=function(t){function s(e){t.call(this),this.elementType=e,this.elements=[],this.$length=new o.BasicSignal(0),this.changes=new o.BasicObservable,this.scheduled=!1}return __extends(s,t),s.prototype.getLength=function(){return this.$length.get()},s.prototype.setLength=function(t){var e=this.$length.get();if(e>t)for(var i=e-1;i>=t;--i)void 0!==this.elements[i]&&(this.elements[i]=void 0,this.changes.sendNext(i),this.scheduleNext());else for(var i=e;t>i;++i)s.prototype.hasOwnProperty(i.toString())||Object.defineProperty(s.prototype,i.toString(),{configurable:!1,enumerable:!0,get:n(i),set:r(i)});this.$length.set(t)},s.prototype.get=function(t){return this.elements[t]},s.prototype.set=function(t,e){this.$length.get()<=t&&this.setLength(t+1),(void 0!==this.elements[t]||void 0!==e)&&(this.elements[t]=e,this.changes.sendNext(t),this.scheduleNext())},s.prototype.push=function(t){var e=this.$length.get();this.set(e,t)},s.prototype.expand=function(t,n){void 0===n&&(n=this.$length.get());var r,i;if("number"==typeof t?(r=t,i=[]):Array.isArray(t)?(i=t,r=t.length):(i=[t],r=1),r>0){var o=this.getLength(),s=o+r;this.setLength(s);for(var a=o-1;a>=n;--a)this.set(a+r,this.elements[a]);if(this.elementType){var h,u;"function"==typeof this.elementType?h=this.elementType:(h=e.Context,u=this.elementType);for(var a=0,c=r;c>a;++a){var d=new h;u&&e.Context.construct(d,u,i[a]),this.set(n+a,d),e.Context.claim(this,d)}}else for(var a=n,c=n+r;c>a;++a)this.set(a,void 0)}},s.prototype.collapse=function(t,n){if(void 0===n&&(n=this.$length.get()-t),t>0){for(var r=this.getLength(),i=r-t,o=n,s=n+t;s>o;++o){var a=this.elements[o];void 0!==a&&e.Context.release(this,a)&&a instanceof e.Context&&e.Context.destruct(a)}for(var o=n;i>o;++o)this.set(o,this.elements[o+t]);this.setLength(i)}},s.prototype.move=function(t,e,n){if(void 0===n&&(n=1),t>this.elements.length-1&&(t=this.elements.length-1),0>t&&(t=0),e>this.elements.length-n&&(e=this.elements.length-n),0>e&&(e=0),n>this.elements.length&&(n=this.elements.length),!(0>n||t==e)){if(e>t)var r=t,i=e,o=e+n;else var r=e,i=e+n,o=t+n;var s=this.elements.slice(r,i),a=this.elements.slice(i,o);Array.prototype.splice.apply(this.elements,[r,a.length].concat(a)),Array.prototype.splice.apply(this.elements,[r+a.length,s.length].concat(s));for(var h=r;o>h;++h)this.changes.sendNext(h);this.scheduleNext()}},s.prototype.addObserver=function(t){this.observers?this.observers.push(t):this.observers=[t],t.onNext(this)},s.prototype.removeObserver=function(t){this.observers&&(this.observers=this.observers.filter(function(e){return t!==e}),0==this.observers.length&&(this.observers=void 0))},s.prototype.scheduleNext=function(){this.scheduled||(this.scheduled=!0,i.schedule(o.SignalPriority,this.sendNext,this))},s.prototype.sendNext=function(){if(this.scheduled=!1,this.observers)for(var t=0,e=this.observers.length;e>t;++t)this.observers[t].onNext&&this.observers[t].onNext(this)},s}(e.Context);e.ArrayContext=s,Object.defineProperty(s.prototype,"length",{configurable:!1,enumerable:!1,get:s.prototype.getLength,set:s.prototype.setLength})}(e=t.model||(t.model={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){var r={};t.variables().forEach(function(t){u.stringSet.add(r,t)});for(var i in n.compmids){for(var o=n.compmids[i],s={},a=0,h=o.length;h>a;++a){var c=o[a];s=e.outputsForMethod(c).reduce(u.stringSet.build,s)}var d=u.stringSet.difference(r,s);t.addMethod(i,n.id,u.stringSet.members(d),u.stringSet.members(s))}}function r(t,e){var r=new c.CachingConstraintGraph;return t.variables().forEach(r.addVariable,r),n(r,t,e),r}function i(t){for(var e=t.constraints().filter(c.isNotStayConstraint).map(p.fromPrimitive.bind(null,t));e.length>1;){for(var n=[],r=0,i=e.length;i>r;r+=2)n.push(i>r+1?o(e[r],e[r+1],t):e[r]);e=n}return e[0]}function o(t,e,n){for(var r=u.arraySet.unionKnownDisjoint(t.cids,e.cids),i=new p(r),o=t.getMethodIds(),a=e.getMethodIds(),h=o.length-1;h>=0;--h)for(var d=o[h],l=a.length-1;l>=0;--l){var f=a[l],v=u.arraySet.unionKnownDisjoint(t.getPrimitiveIdsForMethod(d),e.getPrimitiveIdsForMethod(f)),g=new c.Digraph;n.variables().forEach(g.addNode,g),v.forEach(function(t){var e=n.inputsForMethod(t),r=n.outputsForMethod(t);g.addNode(t),e.forEach(g.addEdgeTo(t)),r.forEach(g.addEdgeFrom(t))}),s(g,v.reduce(u.stringSet.build,{}))&&i.addMethod(v)}return i}function s(t,e){var n={},r=[],i=t.getNodes(),o=!1;if(i.forEach(function(i){var s=t.getInsFor(i).length;n[i]=s,0==s?r.push(i):s>1&&!e[i]&&(o=!0)}),o)return!1;for(var s=function(t){0==--n[t]&&r.push(t)},a=0;r.length>0;){var h=r.pop();++a,t.getOutsFor(h).forEach(s)}return a==i.length}function a(t){var e="composite";if(d.debugIds){var n=[];t.forEach(function(t){0!=n.length&&n.push(" + "),n.push("(",t.substring(0,t.indexOf("#")),")")}),e=n.join("")}return d.makeId(e)}function h(t){var e="composite";if(d.debugIds){var n=[];t.forEach(function(t){0!=n.length&&n.push(" + "),n.push("(",t.substring(0,t.indexOf("#")),")")}),e=n.join("")}return d.makeId(e)}var u=t.utility,c=t.graph,d=t.model,p=function(){function t(t){this.compmids={},this.cids=t,this.id=a(this.cids)}return t.fromPrimitive=function(e,n){var r=new t([n]);return e.methodsForConstraint(n).forEach(r.addMethod,r),r},t.prototype.getMethodIds=function(){return Object.keys(this.compmids)},t.prototype.getPrimitiveIdsForMethod=function(t){return this.compmids[t]},t.prototype.addMethod=function(t){Array.isArray(t)||(t=[t]);var e=h(t);this.compmids[e]=t},t}();e.CompositeConstraint=p,e.addCompositeMethods=n,e.makeConstraintGraph=r,e.composeAllConstraints=i}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){for(var n,r=t.getRoot(),i=1==t.order?e.length-1:0,o=1==t.order?-1:1;r&&!(n=t.getLeafValue(r));){var s=t.getTransitions(r)[e[i]];s&&(r=s),i+=o}return n?n:null}var r=t.utility;!function(t){t[t.Low=0]="Low",t[t.High=1]="High"}(e.Order||(e.Order={}));var i=(e.Order,function(){function t(){this.transitions={},this.leafs={},this.root=null,this.count=0}return t.prototype.addNode=function(t){var e="n"+this.count++;return this.count%1e3==0&&r.console.compile.error(this.count+" nodes..."),this.transitions[e]=t,e},t.prototype.getNodes=function(){return Object.keys(this.transitions)},t.prototype.getTransitions=function(t){return this.transitions[t]},t.prototype.setRoot=function(t){this.root=t},t.prototype.getRoot=function(){return this.root},t.prototype.addLeaf=function(t){return this.leafs[t]=!0,t},t.prototype.getLeafValue=function(t){return this.leafs[t]?t:null},t}());e.SoftLinkedDfa=i;var o=function(){function t(){this.nodes=[],this.root=null}return t.prototype.addNode=function(t){return this.nodes.push(t),t},t.prototype.getNodes=function(){return this.nodes},t.prototype.getTransitions=function(t){return t},t.prototype.setRoot=function(t){this.root=t},t.prototype.getRoot=function(){return this.root},t.prototype.addLeaf=function(t){return t},t.prototype.getLeafValue=function(t){return"string"==typeof t?t:null},t}();e.HardLinkedDfa=o,e.runDfa=n}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){var r=e.constraints().filter(i.isNotStayConstraint);if(1!=r.length)return void console.error("Cannot compile a constraint graph to a decision tree unless it consists of a single constraint");for(var s={},a=e.methodsForConstraint(r[0]),h=0,u=a.length;u>h;++h){var c=a[h],d=e.inputsForMethod(c);s[c]=d.map(i.stayConstraint)}var p=e.variables().map(i.stayConstraint),l=new o(s,p);l.buildDfa(t,n)}var r=t.utility,i=t.graph;e.compileToDfa=n;var o=function(){function t(t,e){this.pathCache={},this.transCache={},this.count=0,this.max=0,this.planInputs=t,this.inputs=e}return t.prototype.buildDfa=function(t,e){this.dfa=t,this.dfa.order=e,this.count=0,this.max=this.inputs.length*(this.inputs.length-1),t.setRoot(0==e?this.buildLowTreeNode([],this.inputs):this.buildHighTreeNode([],this.inputs,Object.keys(this.planInputs)))},t.prototype.supplyNode=function(t){var e=Object.keys(t);e.sort();var n=[];e.forEach(function(e){n.push(e,t[e])});var r=n.join(","),i=this.transCache[r];return i?i:this.transCache[r]=this.dfa.addNode(t)},t.prototype.buildHighTreeNode=function(t,e,n){var i={},o=t.slice(0);o.sort();var s=o.join(","),a=this.pathCache[s];if(a)return a;for(var h=0,u=0,c=e.length;c>u;++u){1==t.length&&(++this.count,r.console.compile.error(this.count+"/"+this.max));var d=e.shift(),p=n.filter(function(t){return-1!=this.planInputs[t].indexOf(d)},this);1==p.length?(i[d]=this.dfa.addLeaf(p[0]),++h):p.length>0&&p.length<n.length&&(t.push(d),i[d]=this.buildHighTreeNode(t,e,p),t.pop(),++h),e.push(d)}return 0==h&&console.error("Building decision tree node with no transitions (we should have already found a solution by this point)"),this.pathCache[s]=this.supplyNode(i)},t.prototype.buildLowTreeNode=function(t,e){for(var n={},i=0,o=0,s=e.length;s>o;++o){1==t.length&&(++this.count,r.console.compile.error(this.count+"/"+this.max));var a=e.shift(),h=this.pickPlanFromLow(t,e);h?(n[a]=this.dfa.addLeaf(h),++i):(t.push(a),n[a]=this.buildLowTreeNode(t,e),t.pop(),++i),e.push(a)}return this.supplyNode(n)},t.prototype.pickPlanFromLow=function(t,e){var n=[];for(var i in this.planInputs)r.arraySet.isSubset(e,this.planInputs[i])&&n.push(i);for(var o=t.length-1;o>=0&&n.length>1;){var s=n.filter(function(e){return-1!=this.planInputs[e].indexOf(t[o])},this);s.length>0&&(n=s),--o}return 1==n.length?n[0]:null},t}()}(e=t.dfa||(t.dfa={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(){this.strongest=0,this.weakest=0,this.strengths={}}return t.prototype.setToMax=function(t){this.strengths[t]=++this.strongest},t.prototype.setToMin=function(t){this.strengths[t]=--this.weakest},t.prototype.remove=function(t){delete this.strengths[t]},t.prototype.isRequired=function(t){return!(t in this.strengths)},t.prototype.getOptionalsUnordered=function(){return Object.keys(this.strengths)},t.prototype.compare=function(t,e){return t in this.strengths?e in this.strengths?this.strengths[t]-this.strengths[e]:-1:e in this.strengths?1:0},t}();t.NumericStrengthAssignment=e;var n=function(){function t(){this.strengths=[]}return t.prototype.setToMax=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1),this.strengths.push(t)},t.prototype.setToMin=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1),this.strengths.unshift(t)},t.prototype.setOptionals=function(t){this.strengths=t},t.prototype.remove=function(t){var e=this.strengths.indexOf(t);e>=0&&this.strengths.splice(e,1)},t.prototype.getList=function(){return this.strengths},t.prototype.compare=function(t,e){var n=this.strengths.indexOf(t),r=this.strengths.indexOf(e);return n>=0?r>=0?n-r:-1:r>=0?1:0},t}();t.ListStrengthAssignment=n}(e=t.plan||(t.plan={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){function n(t){return function(e,n){return t.variablesForConstraint(n).forEach(function(t){e.contains(t)||e.addVariable(t)}),t.methodsForConstraint(n).forEach(function(r){e.addMethod(r,n,t.inputsForMethod(r),t.outputsForMethod(r))}),e}}var r=t.utility,i=t.graph,o=function(){function t(t){this.strengths=new e.NumericStrengthAssignment,this.cgraph=t}return t.prototype.getOptionals=function(){var t=this.strengths.getOptionalsUnordered();return t.sort(this.strengths.compare.bind(this.strengths)),t},t.prototype.setOptionals=function(t){this.strengths=new e.NumericStrengthAssignment,t.forEach(this.strengths.setToMax,this.strengths)},t.prototype.removeOptional=function(t){this.strengths.remove(t)},t.prototype.setMaxStrength=function(t){this.strengths.setToMax(t)},t.prototype.setMinStrength=function(t){this.strengths.setToMin(t)},t.prototype.compare=function(t,e){return this.strengths.compare(t,e)},t.prototype.plan=function(t,e){var n=this.sgraph=new s;this.cgraph.variables().forEach(n.addVariable,n),t&&this.cgraph.constraints().forEach(function(e){var r=t.selectedForConstraint(e);r&&n.addMethod(r,e,this.cgraph.inputsForMethod(r),this.cgraph.outputsForMethod(r))},this);var r=new h(this.cgraph,this.strengths,n,e);return r.run()},t.prototype.getSGraph=function(){return this.sgraph},t}();e.QuickPlanner=o;var s=function(t){function e(){t.apply(this,arguments),this.changes={}}return __extends(e,t),e.prototype.selectMethod=function(e,n,r,i){var o=this.selectedForConstraint(e);o!=n&&(e in this.changes?this.changes[e].mid==n&&delete this.changes[e]:this.changes[e]={mid:o,inputs:o?this.inputsForMethod(o):null,outputs:o?this.outputsForMethod(o):null},t.prototype.selectMethod.call(this,e,n,r,i))},e.prototype.rollback=function(){for(var e in this.changes)t.prototype.selectMethod.call(this,e,this.changes[e].mid,this.changes[e].inputs,this.changes[e].outputs);this.changes={}},e.prototype.commit=function(){this.changes={}},e}(i.CachingSolutionGraph);e.QPSolutionGraph=s;var a=function(){function t(t,e,o,s){this.strongestRetractedCid=null,this.undeterminedVids={},this.cidToEnforce=t,this.strengths=o,this.sgraph=s;var a=new i.DigraphWalker(s.graph).nodesUpstreamOtherType(e.variablesForConstraint(t)).map(e.constraintForMethod,e),h=n(e);this.subcgraph=new i.CachingConstraintGraph,this.subcgraph=a.reduce(h,this.subcgraph),this.subcgraph=h(this.subcgraph,t),this.retractableCids=new r.Heap(function(t,e){return o.compare(t,e)<0}),this.retractableCids.pushAll(this.subcgraph.constraints().filter(this.isRetractable,this)),this.freeVarQueue=this.subcgraph.variables().filter(this.isFreeVar,this)}return t.prototype.targetConstraintSatisfied=function(){return null!==this.sgraph.selectedForConstraint(this.cidToEnforce)},t.prototype.getStrongestRetractedCid=function(){return this.strongestRetractedCid},t.prototype.getUndeterminedVids=function(){return r.stringSet.members(this.undeterminedVids)},t.prototype.run=function(){for(this.enforceConstraintsForAnyFreeVariables();!this.targetConstraintSatisfied()&&this.retractableCids.length>0;){var t=this.retractableCids.pop();this.determineConstraint(t,null),this.enforceConstraintsForAnyFreeVariables()}return this.targetConstraintSatisfied()?(this.sgraph.commit(),!0):(this.sgraph.rollback(),!1)},t.prototype.enforceConstraintsForAnyFreeVariables=function(){for(;!this.targetConstraintSatisfied()&&this.freeVarQueue.length>0;){var t=this.freeVarQueue.pop(),e=this.subcgraph.constraintsWhichOutput(t);if(1==e.length){var n=e[0],r=this.bestSelectableMethod(n);r&&this.determineConstraint(n,r)}}},t.prototype.bestSelectableMethod=function(t){var e=this.subcgraph.methodsForConstraint(t),n=null,r=0;return e.forEach(function(t){var e=this.subcgraph.outputsForMethod(t);e.every(this.isFreeVar,this)&&(null===n||r>e.length)&&(n=t,r=e.length)},this),n},t.prototype.determineConstraint=function(t,e){var n=this.sgraph.selectedForConstraint(t);n&&this.sgraph.outputsForMethod(n).forEach(this.makeUndetermined,this),this.sgraph.selectMethod(t,e,this.subcgraph.inputsForMethod(e),this.subcgraph.outputsForMethod(e)),e&&this.sgraph.outputsForMethod(e).forEach(this.makeDetermined,this);var r=this.subcgraph.outputsForConstraint(t);this.subcgraph.methodsForConstraint(t).forEach(this.subcgraph.removeMethod,this.subcgraph),this.freeVarQueue=this.freeVarQueue.concat(r.filter(this.isFreeVar,this)),null===e&&(null===this.strongestRetractedCid||this.strengths.compare(this.strongestRetractedCid,t)<0)&&(this.strongestRetractedCid=t)},t.prototype.isFreeVar=function(t){var e=this.subcgraph.constraintsWhichOutput(t);return 1==e.length},t.prototype.isRetractable=function(t){return this.strengths.compare(t,this.cidToEnforce)<0},t.prototype.makeUndetermined=function(t){r.stringSet.add(this.undeterminedVids,t)},t.prototype.makeDetermined=function(t){r.stringSet.remove(this.undeterminedVids,t)},t}(),h=function(){function t(t,e,n,i){this.cgraph=t,this.sgraph=n,this.strengths=e,this.cidsToEnforce=new r.Heap(function(t,n){return e.compare(t,n)>0}),this.cidsToEnforce.pushAll(i)}return t.prototype.run=function(){for(var t=!0;this.cidsToEnforce.length>0;){var e=this.cidsToEnforce.pop(),n=new a(e,this.cgraph,this.strengths,this.sgraph);if(n.run()){var r=n.getStrongestRetractedCid();if(r){var i=this.collectDownstreamUnenforced(e,r,n.getUndeterminedVids());i.forEach(function(t){this.cidsToEnforce.contains(t)||this.cidsToEnforce.push(t)},this)}}else this.strengths.isRequired(e)&&(t=!1)}return t},t.prototype.collectDownstreamUnenforced=function(t,e,n){var o=this.sgraph.selectedForConstraint(t),s=r.arraySet.union(this.sgraph.outputsForMethod(o),n),a=new i.DigraphWalker(this.sgraph.graph).nodesDownstreamSameType(s),h=a.map(this.cgraph.constraintsWhichOutput,this.cgraph).reduce(function(t,e){return e.reduce(r.stringSet.build,t)},{});return r.stringSet.members(h).filter(function(t){return this.strengths.compare(t,e)<0&&null===this.sgraph.selectedForConstraint(t)},this)},t}()}(e=t.plan||(t.plan={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.graph,r=function(){function t(t,n,r,i){this.cidIndexes={},this.cidCount=0,this.strengths=new e.ListStrengthAssignment,this.cidIndexes=t,this.cidCount=Object.keys(t).length,this.mids=n,this.fn=r,this.cgraph=i}return t.prototype.getOptionals=function(){var t=[];for(var e in this.cidIndexes)t[this.cidIndexes[e]]=e;return this.strengths.getList().map(function(e){return t[e]})},t.prototype.setOptionals=function(t){for(var e=0,n=t.length;n>e;++e){var r=t[e];r in this.cidIndexes||(this.cidIndexes[r]=this.cidCount++)}this.strengths.setOptionals(t.map(function(t){return this.cidIndexes[t]},this))},t.prototype.removeOptional=function(){console.error("Cannot make modifications to constraint graph with DFA planner")},t.prototype.setMaxStrength=function(t){var e=this.cidIndexes[t];void 0===e&&(e=this.cidIndexes[t]=this.cidCount++),this.strengths.setToMax(e)},t.prototype.setMinStrength=function(t){var e=this.cidIndexes[t];void 0===e&&(e=this.cidIndexes[t]=this.cidCount++),this.strengths.setToMin(e)},t.prototype.compare=function(t,e){return this.strengths.compare(this.cidIndexes[t],this.cidIndexes[e])},t.prototype.plan=function(){var t=this.fn.call(null,this.strengths.getList());return t?(this.selectedMethods=t,!0):!1},t.prototype.getSGraph=function(){var t=new n.CachingSolutionGraph;this.cgraph.variables().forEach(t.addVariable,t);for(var e=0,r=this.selectedMethods.length;r>e;++e){var i=this.mids[this.selectedMethods[e]];t.addMethod(i,this.cgraph.constraintForMethod(i),this.cgraph.inputsForMethod(i),this.cgraph.outputsForMethod(i))}return t},t}();e.DfaFnPlanner=r}(e=t.plan||(t.plan={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.graph,r=t.dfa,i=function(){function t(t){this.compcgraph=new n.CachingConstraintGraph,this.strengths=new e.ListStrengthAssignment,this.cgraph=t,this.recompose()}return t.prototype.getOptionals=function(){return this.strengths.getList()},t.prototype.setOptionals=function(t){this.strengths.setOptionals(t)},t.prototype.removeOptional=function(t){this.strengths.remove(t)},t.prototype.setMaxStrength=function(t){this.strengths.setToMax(t)},t.prototype.setMinStrength=function(t){this.strengths.setToMin(t)},t.prototype.compare=function(t,e){return this.strengths.compare(t,e)},t.prototype.plan=function(t,e){return e.some(n.isNotStayConstraint)&&this.recompose(),this.selected=r.runDfa(this.dfa,this.strengths.getList()),this.selected?!0:!1},t.prototype.getSGraph=function(){var t=new n.CachingSolutionGraph;this.cgraph.variables().forEach(t.addVariable,t);for(var e=this.composite.compmids[this.selected],r=0,i=e.length;i>r;++r){var o=e[r];t.addMethod(o,this.cgraph.constraintForMethod(o),this.cgraph.inputsForMethod(o),this.cgraph.outputsForMethod(o))}return t},t.prototype.recompose=function(){this.composite=r.composeAllConstraints(this.cgraph),this.compcgraph.methods().forEach(this.compcgraph.removeMethod,this.compcgraph),this.compcgraph.variables().forEach(this.compcgraph.removeVariable,this.compcgraph),this.cgraph.variables().forEach(this.compcgraph.addVariable,this.compcgraph),r.addCompositeMethods(this.compcgraph,this.cgraph,this.composite),this.dfa=new r.SoftLinkedDfa,r.compileToDfa(this.dfa,this.compcgraph,1)
},t}();e.ComposedPlanner=i}(e=t.plan||(t.plan={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.utility,r=t.reactive;!function(t){t[t.Irrelevant=1]="Irrelevant",t[t.AssumedRelevant=2]="AssumedRelevant",t[t.Relevant=3]="Relevant"}(e.Label||(e.Label={}));var i=(e.Label,function(t){function e(){t.apply(this,arguments),this.selected={},this.labels={},this.scheduled=!1}return __extends(e,t),e.prototype.selectMethod=function(t,e){var n=this.selected[t],r=!1;if(n){var i=this.labels[n];for(var o in i)if(2!==i[o]){r=!0;break}e==n?r&&(this.labels[n]={}):delete this.labels[n]}e&&e!=n&&(this.labels[e]={}),this.selected[t]=e,(n!==e||r)&&this.schedule()},e.prototype.getLabel=function(t,e){var n=this.labels[e];if(n){var r=n[t];return r?r:2}return 2},e.prototype.setLabel=function(t,e,n){var r=this.labels[e];r&&r[t]!==n&&(r[t]=n,this.schedule())},e.prototype.schedule=function(){this.scheduled||(this.scheduled=!0,n.schedule(4,this.notify,this))},e.prototype.notify=function(){this.scheduled=!1,this.sendNext(this)},e}(r.BasicObservable));e.EnablementLabels=i}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=(t.reactive,function(){function t(t,e,n,r){this.completedCount=0,this.egraph=t,this.mid=e,this.inputVids=Object.keys(n),this.outputCount=0;for(var i in n)n[i].usage.addObserver(this,this.onNextUsage,null,null,i);for(var i in r)r[i].addObserver(this,null,null,this.onCompletedOutput),++this.outputCount}return t.prototype.onCompletedOutput=function(){if(++this.completedCount==this.outputCount&&this.egraph)for(var t=0,e=this.inputVids.length;e>t;++t){var n=this.inputVids[t];2===this.egraph.getLabel(n,this.mid)&&this.egraph.setLabel(n,this.mid,1)}},t.prototype.onNextUsage=function(t,e){this.egraph&&(1===t?this.egraph.setLabel(e,this.mid,3):2===t?this.egraph.setLabel(e,this.mid,1):this.completedCount<this.outputCount&&this.egraph.setLabel(e,this.mid,2))},t.prototype.cancel=function(){this.egraph=null},t}());e.EnableReporter=n;var r=function(){function t(){this.egraph=new e.EnablementLabels,this.reporters={}}return t.prototype.methodScheduled=function(t,e,r,i){this.egraph.selectMethod(t,e),this.reporters[t]&&(this.reporters[t].cancel(),e||delete this.reporters[t]),e&&(this.reporters[t]=new n(this.egraph,e,r,i))},t}();e.EnablementManager=r}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e,n){function r(n,o){if(o>(i[n]||0)){i[n]=o;for(var s=t.methodsWhichOutput(n),a=0,h=s.length;h>a;++a){var u=s[a],c=t.inputsForMethod(u);c.sort(function(t,n){return e.getLabel(n,u)-e.getLabel(t,u)});for(var d=0,p=c.length;p>d;++d){var l=c[d],f=Math.min(o,e.getLabel(l,u));r(l,f)}}}}var i={};return n.forEach(function(t){r(t,3)}),i}function r(t,e,n,r){function o(r){if(n[r]&&i(t,s))return!0;for(var a=t.methodsWhichInput(r),h=0,u=a.length;u>h;++h){var c=a[h],d=t.constraintForMethod(c);if(!s[d]&&1!==e.getLabel(r,c)){s[d]=c;for(var p=t.outputsForMethod(c),l=0,f=p.length;f>l;++l)if(o(p[l]))return!0;s[d]=null}}return!1}var s={};return o(r)?1:0}function i(t,e){function n(){for(var n=t.constraints(),r=0,i=n.length;i>r;++r){var s=n[r];if(!o.isStayConstraint(s))if(e[s])for(var h=t.outputsForMethod(e[s]),l=0,f=h.length;f>l;++l)d[h[l]]=-1;else{u[s]=!0,++c;for(var h=t.outputsForConstraint(s),l=0,f=h.length;f>l;++l){var v=h[l],g=d[v];-1!=g&&(d[v]=g?g+1:1)}}}p=t.variables().filter(a)}function r(){for(;c>0&&p.length>0;){var e=p.pop(),n=t.constraintsWhichOutput(e).filter(h);if(1==n.length){var r=n[0];i(r)&&s(r)}}}function i(e){for(var n=t.methodsForConstraint(e),r=0,i=n.length;i>r;++r){var o=n[r],s=t.outputsForMethod(o);if(s.every(a))return!0}return!1}function s(e){u[e]=!1,--c;t.outputsForConstraint(e).forEach(function(t){1==--d[t]&&p.push(t)})}function a(t){return 1==d[t]}function h(t){return u[t]}var u={},c=0,d={},p=[];return n(),r(),0==c}var o=(t.utility,t.graph);e.globalContributingCheck=n,e.relevancyCheck=r}(e=t.enable||(t.enable={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){e.defaultPlannerType=t.plan.QuickPlanner,e.forwardEmergingSources=!1}(e=t.config||(t.config={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.utility,r=t.reactive,i=t.model,o=t.graph,s=t.enable,a=t.config;e.SystemUpdatePriority=1,e.SystemCommandPriority=2;var h=function(){function h(t,e){void 0===t&&(t=a.defaultPlannerType),void 0===e&&(e=o.CachingConstraintGraph),this.sgraph=null,this.variables={},this.methods={},this.constraints={},this.scheduleUpdateOnChange=!0,this.isUpdateScheduled=!1,this.solved=new r.ScheduledSignal(!0),this.pendingCount=0,this.needUpdating=[],this.needEnforcing={},this.needEvaluating={},this.isUpdateNeeded=!1,this.touchDeps={},this.enable=new s.EnablementManager,this.outputVids={},this.commandQueue=[],this.isCommandScheduled=!1,this.cgraph=new e,t&&(this.planner=new t(this.cgraph)),this.enable.egraph.addObserver(this,this.onNextEgraph,null,null)}return h.prototype.getCGraph=function(){return this.cgraph},h.prototype.getSGraph=function(){return this.sgraph},h.prototype.getPlanner=function(){return this.planner||(this.planner=new a.defaultPlannerType(this.cgraph)),this.planner},h.prototype.switchToNewPlanner=function(t){var e=new t(this.cgraph);if(this.planner){var n=this.planner;e.setOptionals(n.getOptionals())}this.planner=e,this.cgraph.constraints().forEach(this.recordConstraintChange,this)},h.prototype.add=function(t){t instanceof i.Variable?this.addVariable(t):t instanceof i.Context?this.addComponent(t):t instanceof i.Constraint?this.addConstraint(t):t instanceof i.Output?this.addOutput(t.variable):t instanceof i.TouchDep?this.addTouchDependency(t.from,t.to):t instanceof i.Command&&this.addCommand(t)},h.prototype.remove=function(t){t instanceof i.Variable?this.removeVariable(t):t instanceof i.Context?this.removeComponent(t):t instanceof i.Constraint?this.removeConstraint(t):t instanceof i.Output?this.removeOutput(t.variable):t instanceof i.TouchDep?this.removeTouchDependency(t.from,t.to):t instanceof i.Command&&this.removeCommand(t)},h.prototype.addComponent=function(t){i.Context.update(t),i.Context.elements(t).forEach(this.add,this),i.Context.changes(t).addObserver(this,this.recordContextChange,null,null)},h.prototype.removeComponent=function(t){i.Context.elements(t).forEach(this.remove,this),i.Context.changes(t).removeObserver(this),this.removeContextRecords(t)},h.prototype.addVariable=function(t){if(!(t.id in this.variables)){this.variables[t.id]=t,t.pending.get()&&++this.pendingCount,t.changes.addObserver(this,this.onNextVariableChange,null,null);var e=o.stayMethod(t.id),n=o.stayConstraint(t.id);this.cgraph.addVariable(t.id),this.cgraph.addMethod(e,n,[],[t.id]),1===t.optional?this.getPlanner().setMaxStrength(n):2===t.optional&&this.getPlanner().setMinStrength(n),this.recordConstraintChange(n)}},h.prototype.removeVariable=function(t){if(t.id in this.variables){var e=o.stayConstraint(t.id);delete this.variables[t.id],delete this.outputVids[t.id],this.removeConstraintRecords(e),t.changes.removeObserver(this),this.cgraph.removeMethod(o.stayMethod(t.id)),this.planner.removeOptional(e),this.cgraph.removeVariable(t.id)}},h.prototype.addConstraint=function(t){!(t.id in this.constraints)&&t.methods.length>0&&(this.constraints[t.id]=t,t.methods.forEach(this.addMethod.bind(this,t.id)),1===t.optional?(this.getPlanner().setMaxStrength(t.id),this.hasOptionals=!0):2===t.optional&&(this.getPlanner().setMinStrength(t.id),this.hasOptionals=!0),t.touchVariables&&t.touchVariables.forEach(function(e){this.addTouchDependency(e,t)},this),this.recordConstraintChange(t.id))},h.prototype.removeConstraint=function(t){if(t.id in this.constraints){if(delete this.constraints[t.id],this.removeConstraintRecords(t.id),t.touchVariables&&t.touchVariables.forEach(function(e){this.removeTouchDependency(e,t)},this),this.sgraph){var e=this.sgraph.selectedForConstraint(t.id);this.sgraph.outputsForMethod(e).forEach(function(t){if(this.variables[t])for(var e=this.cgraph.constraintsWhichOutput(t),n=0,r=e.length;r>n;++n)this.sgraph.selectedForConstraint(e[n])||(this.needEnforcing[e[n]]=!0)},this)}t.methods.forEach(this.removeMethod,this),this.sgraph.selectMethod(t.id,null),this.enable.methodScheduled(t.id,null)}},h.prototype.addMethod=function(t,e){e.id in this.methods||(this.methods[e.id]=e,this.cgraph.addMethod(e.id,t,e.inputVars.map(n.getId),e.outputs.map(n.getId)))},h.prototype.removeMethod=function(t){t.id in this.methods&&(delete this.methods[t.id],this.cgraph.removeMethod(t.id))},h.prototype.addCommand=function(t){t.addObserver(this,this.scheduleCommand,null,null)},h.prototype.removeCommand=function(t){t.removeObserver(this)},h.prototype.addTouchDependency=function(t,e){var r,s;r=t instanceof i.Variable?o.stayConstraint(t.id):t.id,s=e instanceof i.Variable?o.stayConstraint(e.id):e.id,this.touchDeps[r]?n.arraySet.add(this.touchDeps[r],s):this.touchDeps[r]=[s]},h.prototype.addTouchDependencies=function(t,e){for(var n=0,r=e.length;r>n;++n)this.addTouchDependency(t,e[n])},h.prototype.addTouchSet=function(t){for(var e=0,n=t.length;n>e;++e)for(var r=0;n>r;++r)e!=r&&this.addTouchDependency(t[e],t[r])},h.prototype.removeTouchDependency=function(t,e){var r,s;r=t instanceof i.Variable?o.stayConstraint(t.id):t.id,s=e instanceof i.Variable?o.stayConstraint(e.id):e.id;var a=this.touchDeps[r];a&&n.arraySet.remove(this.touchDeps[r],s)},h.prototype.removeTouchDependencies=function(t,e){for(var n=0,r=e.length;r>n;++n)this.removeTouchDependency(t,e[n])},h.prototype.removeTouchSet=function(t){for(var e=0,n=t.length;n>e;++e)for(var r=0;n>r;++r)e!=r&&this.removeTouchDependency(t[e],t[r])},h.prototype.addOutput=function(t){var e=t.id;e in this.outputVids?++this.outputVids[e]:this.outputVids[e]=1},h.prototype.removeOutput=function(t){var e=t.id;this.outputVids[e]>1?--this.outputVids[e]:delete this.outputVids[t.id]},h.prototype.onNextVariableChange=function(t){switch(t.type){case 1:this.variableTouched(t.vv);break;case 0:this.variableChanged(t.vv);break;case 2:++this.pendingCount;break;case 3:this.pendingCount>0&&(--this.pendingCount,0!=this.pendingCount||this.isUpdateNeeded||this.solved.set(!0));break;case 4:this.scheduleCommand(t.cmd)}},h.prototype.doPromotions=function(t){var e=this.getPlanner(),n=function(t,n){return e.compare(n,t)},r=[],i=0,o={};for(r.push(t),o[t]=!0;i<r.length;){for(var s=r.length,a=[];s>i;){var h=r[i++],u=this.touchDeps[h];u&&u.forEach(function(t){o[t]||this.constraints[t]&&0===this.constraints[t].optional||(a.push(t),o[t]=!0)},this)}r.push.apply(r,a.sort(n))}for(--i;i>=0;--i){var c=r[i];e.setMaxStrength(c),this.sgraph&&this.sgraph.selectedForConstraint(c)||this.recordConstraintChange(c)}},h.prototype.variableTouched=function(t){var e=o.stayConstraint(t.id);this.doPromotions(e)},h.prototype.variableChanged=function(t){var e=o.stayConstraint(t.id);this.doPromotions(e),this.recordVariableChange(e)},h.prototype.recordContextChange=function(t){this.needUpdating.push(t),this.recordChange()},h.prototype.recordConstraintChange=function(t){this.needEnforcing[t]=!0,this.recordChange()},h.prototype.recordVariableChange=function(t){this.needEvaluating[t]=!0,this.recordChange()},h.prototype.recordChange=function(){this.isUpdateNeeded=!0,this.solved.set(!1),this.scheduleUpdateOnChange&&this.scheduleUpdate()},h.prototype.removeConstraintRecords=function(t){delete this.needEnforcing[t],delete this.needEvaluating[t]},h.prototype.removeContextRecords=function(t){n.arraySet.remove(this.needUpdating,t)},h.prototype.scheduleUpdate=function(){this.isUpdateScheduled||(this.isUpdateScheduled=!0,n.schedule(e.SystemUpdatePriority,this.performScheduledUpdate,this))},h.prototype.performScheduledUpdate=function(){this.isUpdateScheduled=!1,this.update()},h.prototype.update=function(){this.isUpdateNeeded&&(this.isUpdateNeeded=!1,this.commitModifications(),this.plan(),this.evaluate(),0==this.pendingCount&&this.solved.set(!0))},h.prototype.commitModifications=function(){for(;this.needUpdating.length>0;){for(var t=this.needUpdating.shift(),e=i.Context.update(t),n=0,r=e.removes.length;r>n;++n)this.remove(e.removes[n]);for(var n=0,r=e.adds.length;r>n;++n)this.add(e.adds[n])}},h.prototype.plan=function(){var r=n.stringSet.members(this.needEnforcing);if(r.length>0){if(this.planner.plan(this.sgraph,r)){this.sgraph=this.planner.getSGraph();var i=e.topograph(this.cgraph,this.sgraph);this.topomids=e.toposort(i,this.planner);for(var s=[],a=this.topomids.length-1;a>=0;--a){var h=i.constraintForMethod(this.topomids[a]);(o.isStayConstraint(h)||this.constraints[h].optional)&&s.push(h)}this.planner.setOptionals(s),r.forEach(n.stringSet.add.bind(null,this.needEvaluating)),t.config.forwardEmergingSources&&this.sgraph.variables().forEach(this.reevaluateIfEmergingSource,this),this.sgraph.variables().forEach(this.updateSourceStatus,this)}this.needEnforcing={}}},h.prototype.reevaluateIfEmergingSource=function(t){var e=this.variables[t],n=o.stayConstraint(t);!this.sgraph.selectedForConstraint(n)||e.source.get()||this.needEvaluating[n]||(e.makePromise(e.getForwardedPromise()),this.needEvaluating[n]=!0)},h.prototype.updateSourceStatus=function(t){this.variables[t].source.set(this.sgraph.selectedForConstraint(o.stayConstraint(t))?!0:!1)},h.prototype.evaluate=function(){var t=n.stringSet.members(this.needEvaluating);if(t.length>0){for(var r=t.map(function(t){return this.sgraph.selectedForConstraint(t)},this).filter(n.isNotNull),i=new o.DigraphWalker(this.sgraph.graph).nodesDownstreamOtherType(r),s=0,a=i.length;a>s;++s){var h=i[s];this.variables[h].commitPromise()}if(r.length>0){for(var u=new o.DigraphWalker(this.sgraph.graph).nodesDownstreamSameType(r).filter(o.isNotStayMethod).reduce(n.stringSet.build,{}),c=this.topomids.filter(function(t){return u[t]}),s=0,a=c.length;a>s;++s){var d=c[s],p=e.activate(this.methods[d]);this.enable.methodScheduled(this.cgraph.constraintForMethod(d),d,p.inputs,p.outputs)}for(var s=0,a=i.length;a>s;++s){var h=i[s];this.variables[h].commitPromise()}this.needEvaluating={}}}},h.prototype.onNextEgraph=function(t){var e=n.stringSet.members(this.outputVids);if(e.length){var r=s.globalContributingCheck(this.sgraph,t,e);for(var i in this.variables){var o=this.variables[i];3===r[i]?(o.contributing.set(1),o.relevant.set(1)):2===r[i]?(o.contributing.set(2),o.relevant.set(2)):(o.contributing.set(0),o.relevant.set(s.relevancyCheck(this.cgraph,this.enable.egraph,this.outputVids,i)))}}},h.prototype.scheduleCommand=function(t){this.commandQueue.push(t),this.isCommandScheduled||(this.isCommandScheduled=!0,n.schedule(e.SystemCommandPriority,this.performCommands,this))},h.prototype.performCommands=function(){for(this.isCommandScheduled=!1;this.commandQueue.length>0;){var t=this.commandQueue.shift();e.activate(t),t.external&&this.update()}},h}();e.PropertyModel=h}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){void 0===e&&(e=1);for(var n=[],r=0;e>r;++r)n.push(new i.Promise);if(1==e)t=[t];else if(!Array.isArray(t)){console.error("Multi-output constant did not supply array");for(var r=0;e>r;++r)n[r].reject(null);return}for(var r=0;e>r;++r)n[r].resolve(t[r]);return 1==e?n[0]:n}function r(e){for(var r=[],s={},a={},h={},u=0,c=e.inputs.length;c>u;++u){var d,p=e.inputs[u];if(p instanceof o.Variable){if(e.priorFlags&&e.priorFlags[u])(d=s[p.id])||(d=s[p.id]=t.config.forwardPriorGens?p.getForwardedPromise():p.getCurrentPromise());else if(!(d=a[p.id])){d=a[p.id]=new i.Promise;var l=p.getStagedPromise();i.plogger&&i.plogger.register(d,p.name,"input parameter"),d.resolve(l),d.ondropped.addObserver(l)}}else d=new i.Promise,i.plogger&&i.plogger.register(d,e.inputs[u],"constant parameter"),d.resolve(e.inputs[u]);r.push(d)}try{var f;if(f=e.fn?e.fn.apply(null,r):n(e.result,e.outputs.length),e.outputs.length>0)if(1==e.outputs.length)f=[f];else if(!Array.isArray(f))throw new TypeError("Multi-output activating function did not return array")}catch(v){console.error(v),f=[];for(var u=0,c=e.outputs.length;c>u;++u){var g=new i.Promise;g.reject(null),f.push(g)}}for(var u=0,c=e.outputs.length;c>u;++u){var m=e.outputs[u];if(h[m.id])console.error("Operation attempting to output same variable twice");else{var g=f[u];h[m.id]=g,i.plogger&&i.plogger.register(g,m.name,"output parameter"),e.external?m.set(g):m.makePromise(g)}}return{inputs:a,outputs:h}}var i=t.reactive,o=t.model;e.activate=r}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(){return h.makeId("void")}function r(t){return"void#"===t.substring(0,5)}function i(t,e){var n=new a.CachingSolutionGraph;t.variables().forEach(function(t){n.addVariable(t)});for(var r=t.constraints(),i=0,o=r.length;o>i;++i){var s=r[i],u=e.selectedForConstraint(s);u?n.addMethod(u,s,t.inputsForMethod(u),t.outputsForMethod(u)):(u=h.makeId("void"),n.addMethod(u,s,t.outputsForConstraint(s),[]))}return n}function o(t,e){var n=[],r=[],i=new s.Heap(function(n,r){return e.compare(t.constraintForMethod(n),t.constraintForMethod(r))>0}),o={};t.methods().forEach(function(e){var n=t.inputsForMethod(e).length;o[e]=n,0==n&&i.push(e)}),t.variables().forEach(function(e){var n=t.methodsWhichOutput(e).length;o[e]=n,0==n&&r.push(e)});for(var a=function(t){0==--o[t]&&i.push(t)},h=function(t){0==--o[t]&&r.push(t)};r.length>0||i.length>0;){for(;r.length>0;){var u=r.pop();t.methodsWhichInput(u).forEach(a)}if(i.length>0){var c=i.pop();n.push(c),t.outputsForMethod(c).forEach(h)}}return n}var s=t.utility,a=t.graph,h=t.model;e.voidMethod=n,e.isVoidMethod=r,e.topograph=i,e.toposort=o}(e=t.system||(t.system={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){var e=Object.create(t);return e.$this=t,e}function r(t){var e=Object.create(t);return e}function i(t,e){if("object"!=typeof t||!(t instanceof e))throw e.name+" required";return t}function o(t){return"object"==typeof t&&"function"==typeof t.onNext&&"function"==typeof t.onError&&"function"==typeof t.onCompleted}function s(t){return"object"==typeof t&&"function"==typeof t.addObserver&&"function"==typeof t.removeObserver}function a(t){return"object"==typeof t&&"function"==typeof t.onNext&&"function"==typeof t.onError&&"function"==typeof t.onCompleted&&"function"==typeof t.addObserver&&"function"==typeof t.removeObserver}function h(t){if(!t.model)throw"no model specified";if(!t.view)throw"no view specified";if(void 0===t.dir)if(s(t.model)&&o(t.view))t.dir=s(t.view)&&o(t.model)?0:2;else{if(!s(t.view)||!o(t.model))throw"unable to deduce binding direction";t.dir=1}else{if(1!=t.dir){if(!s(t.model))throw"model not observable";if(!o(t.view))throw"view not observer"}if(2!=t.dir){if(!s(t.view))throw"view not observable";if(!o(t.model))throw"model not observer"}}if(1!=t.dir&&t.toView)if(Array.isArray(t.toView)){var e=t.toView;if(!e.every(a))throw"toView contains invalid extension";t.toView=new g.Chain(e)}else if(!a(t.toView))throw"toView is not extension";if(2!=t.dir&&t.toModel)if(Array.isArray(t.toModel)){var e=t.toModel;if(!e.every(a))throw"toModel contains invalid extension";t.toModel=new g.Chain(e)}else if(!a(t.toModel))throw"toModel is not extension";return t}function u(t){var e=h(t);1!=e.dir&&(e.toView?(e.toView.addObserver(e.view),e.model.addObserver(e.toView)):e.model.addObserver(e.view)),2!=e.dir&&(e.toModel?(e.view.addObserver(e.toModel),e.toModel.addObserver(e.model)):e.view.addObserver(e.model))}function c(t){var e=h(t);1!=e.dir&&(e.toView?(e.model.removeObserver(e.toView),e.toView.removeObserver(e.view)):e.model.removeObserver(e.view)),2!=e.dir&&(e.toModel?(e.view.removeObserver(e.toModel),e.toModel.removeObserver(e.model)):e.view.removeObserver(e.model))}function d(t,e){e?"string"==typeof e&&(e=document.getElementById(e)):e=document.body;var n=[];return e.nodeType===Node.ELEMENT_NODE&&p(e,t,n),n}function p(t,e,n){var r=t.getAttribute("data-bind");if(r&&(e=l(r,t,e,n)),e)for(var i=0,o=t.childNodes.length;o>i;++i)t.childNodes[i].nodeType===Node.ELEMENT_NODE&&p(t.childNodes[i],e,n)}function l(t,e,n,r){var i=f(t);if(!i)return n;try{var o=new Function(i),s=o.call(n),a=[];v(s,a)}catch(h){return console.error("Invalid binding declaration: "+JSON.stringify(t),h),n}var c;return a.forEach(function(i){i.view||"function"!=typeof i.mkview||(i.view=new i.mkview(e,n)),i.halt&&(c=null),i.localize&&null!==c&&(c||(c=Object.create(n)),i.localize(c));try{u(i),r.push(i)}catch(o){console.error('Invalid binding "'+t+'"',o)}}),void 0===c?n:c}function f(t){return"with (this) {  return ["+t+"]}"}function v(t,e){for(var n=0,r=t.length;r>n;++n)Array.isArray(t[n])?v(t[n],e):e.push(t[n])}var g=t.reactive;e.mkScope=n,e.localScope=r,function(t){t[t.bi=0]="bi",t[t.v2m=1]="v2m",t[t.m2v=2]="m2v"}(e.Direction||(e.Direction={}));e.Direction;e.checkHtml=i,e.isObserver=o,e.isObservable=s,e.isExtension=a,e.bind=u,e.unbind=c,e.performDeclaredBindings=d}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){(void 0===t||null===t)&&(t="");for(var e=this.el;e.lastChild;)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(t))},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Text=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=new Object,i=function(){function t(t,i,o){this.blurFrom=null,this.blurTo=null,this.initialized=!1,this.el=e.checkHtml(t,HTMLInputElement),this.stable=new n.Stabilizer(o,r),t.addEventListener("input",this.update.bind(this)),t.addEventListener("change",this.onBlur.bind(this))}return t.prototype.addObserver=function(){this.stable.addObserver.apply(this.stable,arguments)},t.prototype.removeObserver=function(){this.stable.removeObserver.apply(this.stable,arguments)},t.prototype.update=function(){this.initialized=!0,this.stable.onNext(this.el.value)},t.prototype.onNext=function(t){void 0===t||null===t?t="":"string"!=typeof t&&(t=t.toString()),this.initialized&&this.el===document.activeElement?this.blurTo=t:(this.el.value!=t&&(this.el.value=t,this.el===document.activeElement&&this.el.select()),this.blurTo=null)},t.prototype.onBlur=function(){null!==this.blurTo&&this.el.value!=this.blurTo&&(this.el.value=this.blurTo),this.blurTo=null,this.initialized=!1,this.stable.onNext(r)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();e.Edit=i}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function t(t,e,n){this.el=n,this.trueClass=t,this.falseClass=e}return t.prototype.onNext=function(t){t?(this.falseClass&&this.el.classList.remove(this.falseClass),this.trueClass&&this.el.classList.add(this.trueClass)):(this.trueClass&&this.el.classList.remove(this.trueClass),this.falseClass&&this.el.classList.add(this.falseClass))},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();t.CssClass=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var __extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},hd;!function(t){var e;!function(e){var n=t.reactive.BasicObservable,r=(function(){function t(t){this.el=t}return t.prototype.onNext=function(t){for(var e=this.el;e.lastChild;)e.removeChild(e.lastChild);t.forEach(function(t){var n=document.createElement("option");n.value=t.id,n.text=t.label?t.label:t.id,e.appendChild(n)});var n=document.createEvent("HTMLEvents");n.initEvent("change",!1,!0),this.el.dispatchEvent(n)},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}(),function(t){function n(n){if(t.call(this),this.el=e.checkHtml(n,HTMLElement),n){var r=this.update.bind(this);n.addEventListener("input",r)}}return __extends(n,t),n.prototype.update=function(){this.sendNext(this.el.value)},n.prototype.onNext=function(t){t&&(this.el.value=t)},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(n));e.Value=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLInputElement);var r=this.update.bind(this);n.addEventListener("input",r),n.addEventListener("change",r)}return __extends(n,t),n.prototype.update=function(){this.sendNext(this.el.checked)},n.prototype.onNext=function(t){this.el.checked=!!t},n.prototype.onError=function(){},n.prototype.onCompleted=function(){},n}(n.BasicObservable);e.Checked=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){this.el.disabled=t?!1:!0},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Enabled=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(){return o||(o=new i),o}var r=t.reactive,i=function(t){function e(){t.call(this);var e=this;document.addEventListener("mousemove",function(t){e.pos={x:t.clientX,y:t.clientY},e.sendNext(e.pos)})}return __extends(e,t),e.prototype.get=function(){return this.pos},e}(r.BasicObservable);e.MousePosition=i;var o;e.getMousePosition=n}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){this.el.style.left=t.x+"px",this.el.style.top=t.y+"px"},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.Position=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLElement),this.el.addEventListener("mousedown",this.onmousedown.bind(this))}return __extends(n,t),n.prototype.onmousedown=function(t){this.sendNext(t)},n}(n.BasicObservable);e.MouseDown=r;var i=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLElement),this.el.addEventListener("mouseup",this.onmouseup.bind(this))}return __extends(n,t),n.prototype.onmouseup=function(t){this.sendNext(t)},n}(n.BasicObservable);e.MouseUp=i;var o=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLElement),this.el.addEventListener("click",this.onclick.bind(this))}return __extends(n,t),n.prototype.onclick=function(t){this.sendNext(t)},n}(n.BasicObservable);e.Click=o;var s=function(t){function n(n){t.call(this),this.el=e.checkHtml(n,HTMLElement),this.el.addEventListener("dblclick",this.ondblclick.bind(this))}return __extends(n,t),n.prototype.ondblclick=function(t){this.sendNext(t)},n}(n.BasicObservable);e.DblClick=s}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(t){function e(e){t.call(this),window.setInterval(this.update.bind(this),e)}return __extends(e,t),e.prototype.update=function(){this.sendNext(new Date)},e}(n.BasicObservable);e.Time=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){var n=t.reactive,r=function(){function t(t,n,r,i){this.body=[],this.name=t,this.idxName=n,this.root=e.checkHtml(r,HTMLElement),this.scope=i;for(var o=r.childNodes.length-1;o>=0;--o)this.body[o]=r.childNodes[o],r.removeChild(r.childNodes[o])}return t.prototype.onNext=function(t){for(;this.root.lastChild;)this.root.removeChild(this.root.lastChild);for(var r=0,i=t.length;i>r;++r){var o=t[r],s=e.localScope(this.scope),a=s["$"+this.name]=new n.Constant(null);if(this.idxName)var h=s["$"+this.idxName]=new n.Constant(0);for(var u=0,c=this.body.length;c>u;++u){var d=this.body[u].cloneNode(!0);this.root.appendChild(d),s[this.name]=o,a.value=o,this.idxName&&(s[this.idxName]=r,h.value=r),e.performDeclaredBindings(s,d)}}},t.prototype.onError=function(){},t.prototype.onCompleted=function(){},t}();e.ForEach=r}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(t){var e=function(){function e(e){this.el=t.checkHtml(e,HTMLElement)}return e.prototype.onNext=function(t){t?this.el.style.removeProperty("display"):this.el.style.display="none"},e.prototype.onError=function(){},e.prototype.onCompleted=function(){},e}();t.When=e}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(){if(0!=arguments.length){if(1==arguments.length){var t=arguments[0];if(Array.isArray(t)){if(!t.every(e.isExtension))throw"Invalid extension passed to chain";return new P.Chain(t)}return t}for(var n=[],r=0,i=arguments.length;i>r;++r){var t=arguments[r];if(Array.isArray(t)){if(!t.every(e.isExtension))throw"Invalid extension passed to chain";Array.prototype.push.apply(n,t)}else if(t){if(!e.isExtension(t))throw"Invalid extension passed to chain";n.push(t)}}return n.length>0?new P.Chain(n):void 0}}function r(t,e){return new P.HotSwap(new M.PathValue(new M.Path(t,e)))}function i(t,e){return new P.ReadWrite(t,e)}function o(){return"function"==typeof arguments[0]?new P.FunctionExtension(arguments[0],null,Array.prototype.slice.call(arguments,1)):new P.FunctionExtension(arguments[1],arguments[0],Array.prototype.slice.call(arguments,2))}function s(t){return new P.Constant(t)}function a(t){return new P.Delay(t)}function h(t,e){return new P.Stabilizer(t,e)}function u(t){return new P.ReplaceError(t)}function c(){return new P.Required}function d(t){return new P.Default(t)}function p(t){return new P.Round(t)}function l(t){return new P.NumberToFixed(t)}function f(t){return new P.NumberToPrecision(t)}function v(t){return new P.NumberToExponential(t)}function g(t){return new P.ScaleNumber(t)}function m(){return new P.ToString}function y(){return new P.ToJson}function b(){return new P.ToDate}function x(){return new P.DateToString}function w(){return new P.DateToDateString}function C(){return new P.DateToTimeString}function O(){return new P.DateToMilliseconds}function N(){return new P.MillisecondsToDate}function E(){return new P.ToNumber}function S(t,e){return new P.Offset(t,e)}function T(){return new P.PointToString}function k(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];return new P.Or(t)}var P=t.reactive,M=t.model;e.chain=n,e.path=r,e.rw=i,e.fn=o,e.cn=s,e.delay=a,e.stabilize=h,e.msg=u,e.req=c,e.def=d,e.round=p,e.fix=l,e.prec=f,e.exp=v,e.scale=g,e.toStr=m,e.toJson=y,e.toDate=b,e.dateToString=x,e.dateToDateString=w,e.dateToTimeString=C,e.dateToMilliseconds=O,e.millisecondsToDate=N,e.toNum=E,e.offset=S,e.pointToString=T,e.or=k}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t,e){return t?e?Array.isArray(t)?t.concat(Array.isArray(e)?e:[e]):Array.isArray(e)?[t].concat(e):[t,e]:t:e}function r(t,n,r){return{mkview:e.Edit,model:t,dir:0,toView:n,toModel:r}}function i(t,e,n){return[r(t,e,n),c(t),d(t.relevant)]}function o(t,r,i,o){return void 0===r||null===r?{mkview:e.Edit,model:t,dir:0,toView:i,toModel:n(new w.ToNumber,o)}:{mkview:e.Edit,model:t,dir:0,toView:n(i,r>=0?new w.NumberToFixed(r):new w.Round(r)),toModel:n([new w.ToNumber,new w.Round(r)],o)}}function s(t,e,n,r){return[o(t,e,n,r),c(t),d(t.relevant)]}function a(t,r,i){return{mkview:e.Edit,model:t,dir:0,toView:n(r,new w.DateToDateString),toModel:n(new w.ToDate,i)}}function h(t,e,n){return[a(t,e,n),c(t),d(t.relevant)]}function u(t,n){return{mkview:e.Text,model:t,toView:n,dir:2}}function c(t,n,r,i){if(!n&&!r&&t instanceof C.Variable){var o=t;return[{mkview:e.CssClass.bind(null,"source","derived"),model:o.source,dir:2},{mkview:e.CssClass.bind(null,"stale","current"),model:o.stale,dir:2},{mkview:e.CssClass.bind(null,"pending","complete"),model:o.pending,dir:2},{mkview:e.CssClass.bind(null,"contributing","noncontributing"),model:o.contributing,dir:2},{mkview:e.CssClass.bind(null,"error",null),model:o.error,dir:2}]}return[{mkview:e.CssClass.bind(null,n,r),model:t,dir:2,toView:i}]}function d(t,n){return{mkview:e.Enabled,model:t,dir:2,toView:n}}function p(t,n,r){return{mkview:e.Value,model:t,dir:0,toView:n,toModel:r}
}function l(t,n,r){return{mkview:e.Checked,model:t,dir:0,toView:n,toModel:r}}function f(t,n){return{mkview:e.MouseDown,model:t,dir:1,toModel:n}}function v(t,n){return{mkview:e.MouseUp,model:t,dir:1,toModel:n}}function g(t,n){return{mkview:e.Click,model:t,dir:1,toModel:n}}function m(t,n){return{mkview:e.DblClick,model:t,dir:1,toModel:n}}function y(t,n){return{mkview:e.Position,model:t,dir:2,toView:n}}function b(t,n,r){return{mkview:e.ForEach.bind(null,t,r),model:n,dir:2,halt:!0}}function x(t,n){return{mkview:e.When,model:t,dir:2,toView:n}}var w=t.reactive,C=t.model;e.edit=r,e.editVar=i,e.num=o,e.numVar=s,e.date=a,e.dateVar=h,e.text=u,e.cssClass=c,e.enabled=d,e.value=p,e.checked=l,e.mousedown=f,e.mouseup=v,e.click=g,e.dblclick=m,e.position=y,e.forEach=b,e.when=x}(e=t.bindings||(t.bindings={}))}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){return!t.hasDependencies()}function r(t,n){var r=e.workerPools[t];r?r.max=n:e.workerPools[t]=new s(t,n)}function i(t,n,r){return void 0===r&&(r=1),e.workerPools[t]||(e.workerPools[t]=new s(t)),function(){var i=e.workerPools[t],o=i.schedule(n,Array.prototype.slice.call(arguments,0,arguments.length),r);return 1==r?o[0]:o}}var o=t.reactive,s=function(){function t(t,e){void 0===e&&(e=20),this.availableWorkers=[],this.runningTasks=[],this.queuedTasks=[],this.sourceUrl=t,this.max=e}return t.prototype.schedule=function(t,e,n){void 0===n&&(n=1);for(var r=[],i=0;n>i;++i)r.push(new o.Promise);var s={fnName:t,inputs:e,outputs:r};return r.forEach(function(t){t.ondropped.addObserver(this,this.onPromiseDropped,null,null,s)},this),this.queuedTasks.push(s),this.checkQueue(),r},t.prototype.checkQueue=function(){for(;this.queuedTasks.length>0&&this.availableWorkers.length>0;)this.execute(this.queuedTasks.shift(),this.availableWorkers.shift());for(;this.queuedTasks.length>0&&this.runningTasks.length<this.max;){var t=this.queuedTasks.shift();try{this.execute(t,new Worker(this.sourceUrl))}catch(e){console.error("Unable to create worker",e),t.outputs.forEach(function(t){t.reject("Script unable to create worker")})}}},t.prototype.execute=function(t,e){t.worker=e,this.runningTasks.push(t),e.onmessage=this.onMessage.bind(this,t),e.onerror=this.onError.bind(this,t),e.postMessage({fnName:t.fnName,inputs:t.inputs})},t.prototype.onMessage=function(t,e){if(e.data.error)console.warn("Task failed: "+JSON.stringify(e.data.error)),t.outputs.forEach(function(t){t.reject(e.data.error)}),this.returnWorker(t.worker);else if(e.data.complete){var n=e.data.result;if(1==t.outputs.length)t.outputs[0].resolve(n);else for(var r=0,i=t.outputs.length;i>r;++r)t.outputs[r].resolve(n[r]);this.returnWorker(t.worker)}else{var n=e.data.result;if(1==t.outputs.length)t.outputs[0].notify(n);else for(var r=0,i=t.outputs.length;i>r;++r)t.outputs[r].notify(n[r])}},t.prototype.onError=function(t,e){console.warn("Worker failed: "+JSON.stringify(e.data)),t.outputs.forEach(function(t){t.reject(e.data)}),this.killWorker(t.worker)},t.prototype.returnWorker=function(t){if(this.runningTasks.length>=this.max)this.killWorker(t);else if(this.queuedTasks.length>0)this.execute(this.queuedTasks.shift(),t);else{var e=this.findTaskIndexFor(t);e>=0&&(this.runningTasks.splice(e,1),t.onmessage=null,t.onerror=null,this.availableWorkers.push(t))}},t.prototype.killWorker=function(t){var e=this.findTaskIndexFor(t);e>=0&&this.runningTasks.splice(e,1),t.terminate(),this.checkQueue()},t.prototype.onPromiseDropped=function(t,e){e.outputs.every(n)&&(e.worker?this.killWorker(e.worker):this.dequeue(e))},t.prototype.dequeue=function(t){var e=this.queuedTasks.indexOf(t);e>=0&&this.queuedTasks.splice(e,1)},t.prototype.findTaskIndexFor=function(t){for(var e=0,n=this.runningTasks.length;n>e;++e)if(this.runningTasks[e].worker===t)return e;return-1},t}();e.WorkerPool=s,e.workerPools={},e.setMaxWorkers=r,e.worker=i}(e=t.async||(t.async={}))}(hd||(hd={}));var hd;!function(t){t.setMaxWorkers=t.async.setMaxWorkers,t.worker=t.async.worker}(hd||(hd={}));var hd;!function(t){var e;!function(e){function n(t){var e=[];for(var n in t)e.push(n+"="+encodeURIComponent(t[n]));return e.join("&")}function r(t,e){e&&(t+="?"+n(e));var r=new XMLHttpRequest,i=new a.Promise;return r.addEventListener("readystatechange",function(){4==r.readyState&&(200==r.status?i.resolve(r):i.reject(r.statusText))}),r.open("GET",t),r.send(),i}function i(t,e){return r(t,e).then(function(t){return t.responseXML})}function o(t,e){return r(t,e).then(function(t){return t.responseText})}function s(t,e){return r(t,e).then(function(t){return JSON.parse(t.responseText)})}var a=t.reactive;e.ajax=r,e.ajaxXML=i,e.ajaxText=o,e.ajaxJSON=s}(e=t.async||(t.async={}))}(hd||(hd={}));var hd;!function(t){t.ajax=t.async.ajax,t.ajaxXML=t.async.ajaxXML,t.ajaxText=t.async.ajaxText,t.ajaxJSON=t.async.ajaxJSON}(hd||(hd={}));var hd;!function(t){function e(t){return a.ArrayContext.bind(null,t)}function n(t){t.usage.set(1)}function r(t){t.usage.set(2)}function i(t){t.usage.set(3)}var o=t.utility,s=t.reactive,a=t.model,h=t.system,u=t.bindings;t.arrayOf=e,t.array=a.ArrayContext,t.markUsed=n,t.markUnused=r,t.markDelayed=i,t.dateCompare=o.dateCompare,t.ProxyObserver=s.ProxyObserver,t.BasicObservable=s.BasicObservable,t.Promise=s.Promise,t.Extension=s.Extension,t.liftFunction=s.liftFunction,t.dir=u.Direction,t.bind=u.bind,t.unbind=u.unbind,t.performDeclaredBindings=u.performDeclaredBindings,t.isObservable=u.isObservable,t.isObserver=u.isObserver,t.isExtension=u.isExtension,t.Variable=a.Variable,t.Constraint=a.Constraint,t.Method=a.Method,t.Context=a.Context,t.ArrayContext=a.ArrayContext,t.MaxOptional=1,t.MinOptional=2,t.PropertyModel=h.PropertyModel,t.ContextBuilder=a.ContextBuilder,t.Checked=u.Checked,t.Click=u.Click,t.CssClass=u.CssClass,t.DblClick=u.DblClick,t.Edit=u.Edit,t.Enabled=u.Enabled,t.MouseDown=u.MouseDown,t.MouseUp=u.MouseUp,t.MousePosition=u.MousePosition,t.Position=u.Position,t.Text=u.Text,t.Time=u.Time,t.Value=u.Value,t.checked=u.checked,t.click=u.click,t.cssClass=u.cssClass,t.dblclick=u.dblclick,t.edit=u.edit,t.editVar=u.editVar,t.date=u.date,t.dateVar=u.dateVar,t.enabled=u.enabled,t.forEach=u.forEach,t.mousedown=u.mousedown,t.mouseup=u.mouseup,t.mousePosition=u.getMousePosition,t.num=u.num,t.numVar=u.numVar,t.position=u.position,t.text=u.text,t.value=u.value,t.when=u.when,t.chain=u.chain,t.cn=u.cn,t.dateToMilliseconds=u.dateToMilliseconds,t.dateToDateString=u.dateToDateString,t.dateToString=u.dateToString,t.dateToTimeString=u.dateToTimeString,t.def=u.def,t.delay=u.delay,t.exp=u.exp,t.fix=u.fix,t.fn=u.fn,t.millisecondsToDate=u.millisecondsToDate,t.msg=u.msg,t.offset=u.offset,t.path=u.path,t.or=u.or,t.pointToString=u.pointToString,t.prec=u.prec,t.rw=u.rw,t.req=u.req,t.round=u.round,t.scale=u.scale,t.stabilize=u.stabilize,t.toDate=u.toDate,t.toJson=u.toJson,t.toNum=u.toNum,t.toStr=u.toStr}(hd||(hd={}));var hd;!function(t){function e(t){return t}function n(){for(var t=arguments[0],e=1,n=arguments.length;n>e;++e)t+=arguments[e];return t}function r(){for(var t=arguments[0],e=1,n=arguments.length;n>e;++e)t-=arguments[e];return t}function i(){for(var t=arguments[0],e=1,n=arguments.length;n>e;++e)t-=arguments[e];return t}function o(){for(var t=arguments[0],e=1,n=arguments.length;n>e;++e)t/=arguments[e]}function s(){for(var t,e=0,n=arguments.length;n>e&&void 0===t;++e)t=arguments[e];for(;n>e;++e)arguments[e]>t&&(t=arguments[e]);return t}function a(){for(var t,e=0,n=arguments.length;n>e&&void 0===t;++e)t=arguments[e];for(;n>e;++e)arguments[e]<t&&(t=arguments[e]);return t}t.id=e,t.sum=n,t.diff=r,t.prod=i,t.quot=o,t.max=s,t.min=a}(hd||(hd={}));